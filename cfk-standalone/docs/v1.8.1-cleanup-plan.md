# v1.8.1 Cleanup Plan - Production-First Methodology

**Branch:** `v1.8.1-cleanup`
**Base:** `v1.7.3-production-hardening`
**Date Created:** October 30, 2025
**Methodology:** Lessons learned from v1.8-cleanup applied correctly

---

## 🎯 Executive Summary

This cleanup initiative applies the **PRODUCTION FIRST PRINCIPLE** to systematically modernize the codebase while maintaining production stability. Unlike v1.8-cleanup (which excluded admin code from quality checks), this approach scans ALL production code from Day 1.

### Key Differences from v1.8-cleanup:

| Aspect | v1.8-cleanup (OLD) | v1.8.1-cleanup (NEW) |
|--------|-------------------|---------------------|
| **Base Branch** | v1.7.2 (before security fixes) | v1.7.3 (current production) |
| **Quality Checks** | Excluded admin/includes | **ALL production code** |
| **Security** | Staging password login | Magic-link only (v1.7.3 security model) |
| **CSP Implementation** | Older version | Latest v1.7.3 nonces |
| **Documentation** | Created afterward | Created alongside changes |
| **Testing** | Manual checklist | Automated + manual verification |

---

## 📚 Reference Documentation (Already Exists)

This plan leverages existing, proven documentation:

1. **Dead Code Analysis**: `docs/audits/dead-code-analysis-report.md`
   - Identifies 3,624 lines in 9 deprecated wrapper files
   - Risk assessment and replacement mapping

2. **Testing Methodology**: `docs/testing/v1.8-cleanup-testing-checklist.md`
   - Comprehensive testing procedures
   - Autoloader verification
   - Cron job testing
   - Admin panel testing
   - Public page testing

3. **Architecture Standards**: `docs/v1.8-architecture-and-coding-standards.md`

4. **Production First Principle**: `CLAUDE.md` (lines 5-48)
   - Documented lesson from v1.8 mistakes
   - Priority hierarchy for code quality

---

## 🚨 Production First Principle - Applied From Day 1

**The Core Rule:**
```
Priority 1: ALL production code (admin, includes, pages, cron) - SCAN EVERYTHING
Priority 2: Modern code (src/)
Priority 3: Dead/deprecated code cleanup
Priority 4: Architecture improvements and migration
```

**What This Means:**
- ✅ PHPStan runs on admin/, includes/, pages/, cron/ from the start
- ✅ Security audits include ALL production files
- ✅ Dead code analysis checks ALL production dependencies
- ✅ Testing covers ALL user-facing functionality
- ❌ NO code is excluded because it's "old" or "being migrated"

---

## 📋 Phase 1: Quality Baseline & Dependency Analysis

**Goal:** Understand current state before making changes

### Step 1.1: Run PHPStan on ALL Production Code

```bash
# Scan EVERYTHING that runs in production
vendor/bin/phpstan analyse \
  admin/ \
  includes/ \
  pages/ \
  cron/ \
  src/ \
  --level 6 \
  > phpstan-v1.8.1-baseline.txt
```

**Expected Output:**
- Document ALL errors (not just src/)
- Categorize by severity (critical, warning, info)
- Create fix priority list

### Step 1.2: Review Dead Code Analysis Report

```bash
# Already exists - review for v1.7.3 accuracy
cat docs/audits/dead-code-analysis-report.md
```

**Action Items:**
- Verify deprecated files still exist in v1.7.3
- Check for new deprecated code added since report
- Update report if v1.7.3 changes affected it

### Step 1.3: Dependency Mapping

**Map ALL production file dependencies:**

```bash
# Create dependency graph
grep -r "require_once\|require\|include_once\|include" \
  admin/ includes/ pages/ cron/ \
  > dependency-map.txt
```

**Manual Analysis:**
- Which files still use deprecated wrappers?
- Which files use namespaced classes?
- What's the migration status of each file?

### Step 1.4: Create Initial Baseline Documentation

**Document:**
```
docs/v1.8.1-baseline-report.md
```

**Contents:**
- PHPStan error count (by directory)
- Deprecated file usage mapping
- Production code quality metrics
- Critical issues requiring immediate fix
- Non-critical cleanup opportunities

---

## 📋 Phase 2: Critical Fixes (Production Safety)

**Goal:** Fix production issues BEFORE cleanup

### Step 2.1: Fix Critical PHPStan Errors in Production Code

**Criteria for "Critical":**
- Fatal errors (undefined methods, classes)
- Type safety issues causing runtime errors
- SQL injection vulnerabilities
- XSS vulnerabilities
- Authentication/authorization issues

**Process:**
1. Fix one error at a time
2. Test in Docker after each fix
3. Commit with descriptive message
4. Run functional tests to verify no regression

**Example Fixes:**
```php
// Fix undefined Database methods
Database::query() → Database::execute()

// Fix missing null checks
$child['age'] → $child['age'] ?? 0

// Fix type mismatches
(string)$id → (int)$id
```

### Step 2.2: Update Production Files Using Deprecated Wrappers

**From dead-code-analysis-report.md:**

**File:** `includes/functions.php` (line 471)
```php
// BEFORE (uses deprecated wrapper)
require_once __DIR__ . '/avatar_manager.php';
return CFK_Avatar_Manager::getAvatarForChild($child);

// AFTER (uses namespaced class)
return \CFK\Avatar\Manager::getAvatarForChild($child);
```

**Process:**
1. Identify all production files using wrappers
2. Update to use namespaced classes
3. Test each change in Docker
4. Verify autoloader works
5. Run functional tests

### Step 2.3: Test Critical Workflows

**Before proceeding to cleanup, verify:**
- [ ] Admin login works (magic link)
- [ ] Child management (add/edit/delete)
- [ ] CSV import
- [ ] Sponsorship workflow (select → reserve → confirm)
- [ ] Email delivery
- [ ] Sponsor portal access
- [ ] Reports generation
- [ ] Cron jobs execute

**Command:**
```bash
./tests/security-functional-tests.sh
```

**Expected:** 35/36 tests pass (same as v1.7.3 baseline)

---

## 📋 Phase 3: Dead Code Removal (Safe Cleanup)

**Goal:** Remove deprecated wrappers safely

### Step 3.1: Verify No Production Dependencies

**For each deprecated file, confirm:**
- No `require` statements in production code
- Autoloader provides class via namespace
- Class alias exists in config (if needed)
- Replacement class is fully functional

### Step 3.2: Delete Deprecated Wrapper Files

**From dead-code-analysis-report.md (9 files, 3,624 lines):**

```bash
# Delete deprecated wrappers (after verification!)
rm includes/archive_manager.php      # 429 lines
rm includes/avatar_manager.php       # 353 lines
rm includes/backup_manager.php       # 236 lines
rm includes/csv_handler.php          # 561 lines
rm includes/email_manager.php        # 763 lines
rm includes/import_analyzer.php      # 29 lines
rm includes/magic_link_manager.php   # 29 lines
rm includes/report_manager.php       # 394 lines
rm includes/sponsorship_manager.php  # 830 lines
```

**Safety Protocol:**
1. Delete ONE file at a time
2. Run Docker tests after each deletion
3. Check error logs for class loading failures
4. Commit after each successful deletion
5. If errors occur, restore and investigate

### Step 3.3: Comprehensive Testing After Cleanup

**Run full testing suite:**

```bash
# 1. PHPStan (verify no new errors)
vendor/bin/phpstan analyse admin/ includes/ pages/ cron/ src/ --level 6

# 2. Functional tests
./tests/security-functional-tests.sh

# 3. Manual testing (follow v1.8-cleanup-testing-checklist.md)
```

**Expected Results:**
- PHPStan: Same or fewer errors than baseline
- Functional tests: 35/36 pass (no regression)
- Manual testing: 100% pass rate

---

## 📋 Phase 4: Documentation & Verification

**Goal:** Document changes and prepare for production

### Step 4.1: Update Documentation

**Create/update:**
```
docs/releases/v1.8.1-cleanup-complete.md
```

**Contents:**
- Summary of changes
- Files deleted (with line counts)
- PHPStan improvements
- Testing results
- Known issues (if any)
- Deployment instructions

### Step 4.2: Create Deployment Checklist

**Include:**
- Pre-deployment backup instructions
- Database migration steps (if any)
- File upload/sync commands
- Post-deployment verification
- Rollback procedure

### Step 4.3: Final Verification

**Before marking ready for production:**
- [ ] All PHPStan critical errors fixed
- [ ] Deprecated wrappers removed
- [ ] Functional tests pass (35/36)
- [ ] Manual testing complete (100%)
- [ ] Documentation updated
- [ ] Deployment plan documented
- [ ] Rollback plan tested

---

## 🔄 Continuous Quality Practices

**Throughout all phases:**

### Daily Quality Checks:
```bash
# Run before committing
vendor/bin/phpstan analyse admin/ includes/ pages/ cron/ src/ --level 6
./tests/security-functional-tests.sh
```

### Git Workflow:
```bash
# Feature branch naming
git checkout -b cleanup/remove-archive-wrapper

# Descriptive commits
git commit -m "refactor: Remove deprecated archive_manager wrapper (429 lines)"

# Test before pushing
./tests/security-functional-tests.sh && git push
```

### Documentation:
- Update docs/ as changes are made (not afterward)
- Document WHY, not just WHAT
- Keep CLAUDE.md updated with lessons learned

---

## 📊 Success Metrics

**How we measure success:**

| Metric | v1.7.3 Baseline | v1.8.1 Goal |
|--------|----------------|-------------|
| **PHPStan Errors (Level 6)** | TBD (Phase 1) | <50% of baseline |
| **Dead Code (lines)** | 3,624+ | 0 deprecated wrappers |
| **Functional Tests** | 35/36 pass | 35/36 pass (no regression) |
| **Production Code Coverage** | Partial (src/ only) | 100% (all dirs) |
| **Documentation** | Scattered | Comprehensive & current |

---

## 🚨 Rollback Plan

**If critical issues are discovered:**

```bash
# Revert to v1.7.3 stable
git checkout v1.7.3-production-hardening

# Deploy to production
./deploy.sh production

# Document issues for future fix
Create GitHub issue with:
- What broke
- Steps to reproduce
- Error messages
- Testing that missed it
```

---

## 🎓 Lessons Applied from v1.8-cleanup

**What we learned:**

1. ✅ **Include ALL production code in quality checks** - No exceptions
2. ✅ **Test admin functionality thoroughly** - 9 bugs were hidden by excluding it
3. ✅ **Document as you go** - Not afterward
4. ✅ **Production safety > Architecture elegance** - Always
5. ✅ **Use automated testing** - Don't rely on manual only

**What we're doing differently:**

- PHPStan on admin/, includes/, pages/, cron/ from Day 1
- Functional tests run after EVERY change
- Documentation created alongside code changes
- Smaller, incremental commits (one file at a time)
- More thorough manual testing checklist

---

## 📅 Timeline Estimate

| Phase | Estimated Time | Dependencies |
|-------|---------------|--------------|
| Phase 1: Baseline | 2-3 hours | None |
| Phase 2: Critical Fixes | 4-6 hours | Phase 1 complete |
| Phase 3: Dead Code Removal | 3-4 hours | Phase 2 complete |
| Phase 4: Documentation | 2-3 hours | Phase 3 complete |
| **Total** | **11-16 hours** | Sequential execution |

**Breakdown by activity:**
- PHPStan analysis & fixes: 6-8 hours
- Dead code removal & testing: 4-5 hours
- Documentation: 2-3 hours

---

## ✅ Ready to Begin

**Checklist before starting Phase 1:**
- [ ] On v1.8.1-cleanup branch
- [ ] Docker environment running
- [ ] Functional test suite passing (baseline)
- [ ] Documentation reviewed
- [ ] .env file configured
- [ ] Backup of production data available

**Next Steps:**
1. Run Phase 1.1: PHPStan baseline
2. Create Phase 1.4: Baseline report
3. Review findings with team
4. Proceed to Phase 2 with approval

---

**Document Version:** 1.0
**Created:** October 30, 2025
**Status:** Ready for execution
**Approval Required:** Yes (before Phase 2)
