# v1.7.3.1 - CSP Nonce Hotfix

**Date:** October 28, 2025
**Type:** Critical Security Hotfix
**Status:** ✅ DEPLOYED AND VERIFIED

## Issue

After deploying v1.7.3, Content Security Policy (CSP) errors appeared in browser console:

```
Refused to execute inline script because it violates the following
Content Security Policy directive: "script-src 'self' 'nonce-...' 'unsafe-eval'
'unsafe-inline' ...". Note that 'unsafe-inline' is ignored if either a hash
or nonce value is present in the source list.
```

**Root Cause:** Variable scope issue with `$cspNonce` variable.

## Technical Problem

The CSP nonce system had multiple conflicting implementations:

1. **config.php** generated nonce (line 119): `$cspNonce = $_SESSION['csp_nonce'];`
2. **header.php** was regenerating it (duplicate generation)
3. **7 page files** were regenerating their own nonces with `bin2hex(random_bytes(16))`
4. **Variable scope**: `$cspNonce` set in config.php wasn't available in included files

**Result:**
- CSP header sent with one nonce value
- HTML script tags had empty nonces (`nonce=""`)
- Browser blocked all scripts

## Solution

### 1. Fixed Variable Scope in config.php

**File:** `config/config.php`

Added `$GLOBALS['cspNonce']` to make nonce available across all includes:

```php
// Generate CSP nonce for this request
if (!isset($_SESSION['csp_nonce'])) {
    $_SESSION['csp_nonce'] = base64_encode(random_bytes(16));
}
$GLOBALS['cspNonce'] = $_SESSION['csp_nonce'];  // ← ADDED
$cspNonce = $_SESSION['csp_nonce'];
```

### 2. Fixed header.php

**File:** `includes/header.php`

- Removed duplicate nonce generation
- Added `global $cspNonce;` declaration
- Fixed missing nonce on Zeffy script tag

**Before:**
```php
<?php
// Set strict Content Security Policy with nonces
if (!isset($_SESSION['csp_nonce'])) {
    $_SESSION['csp_nonce'] = base64_encode(random_bytes(16));
}
$cspNonce = $_SESSION['csp_nonce'];
```

**After:**
```php
<?php
// CSP nonce is generated in config.php and available as $cspNonce
global $cspNonce;
```

**Also fixed Zeffy script:**
```html
<!-- Before -->
<script src="https://zeffy-scripts.s3.ca-central-1.amazonaws.com/embed-form-script.min.js"></script>

<!-- After -->
<script src="https://zeffy-scripts.s3.ca-central-1.amazonaws.com/embed-form-script.min.js" nonce="<?php echo $cspNonce; ?>"></script>
```

### 3. Fixed All Page Files

**Files Modified:**
- pages/about.php
- pages/children.php
- pages/confirm_sponsorship.php
- pages/family.php
- pages/my_sponsorships.php
- pages/reservation_review.php
- pages/reservation_success.php

**Changes:**
1. Removed duplicate nonce generation: `$cspNonce = bin2hex(random_bytes(16));`
2. Added `global $cspNonce;` after security check

**Example (children.php):**

**Before:**
```php
if (!defined('CFK_APP')) {
    http_response_code(403);
    die('Direct access not permitted');
}

$pageTitle = 'Children Needing Sponsorship';

// Generate CSP nonce for inline scripts
$cspNonce = bin2hex(random_bytes(16));
```

**After:**
```php
if (!defined('CFK_APP')) {
    http_response_code(403);
    die('Direct access not permitted');
}

global $cspNonce;
$pageTitle = 'Children Needing Sponsorship';
```

## Files Deployed

```
config/config.php
includes/header.php
pages/about.php
pages/children.php
pages/confirm_sponsorship.php
pages/family.php
pages/my_sponsorships.php
pages/reservation_review.php
pages/reservation_success.php
```

## Deployment Process

```bash
# 1. Deploy config.php
scp config/config.php a4409d26_1@d646a74eb9.nxcli.io:d646a74eb9.nxcli.io/html/config/

# 2. Deploy header.php
scp includes/header.php a4409d26_1@d646a74eb9.nxcli.io:d646a74eb9.nxcli.io/html/includes/

# 3. Deploy all page files
scp pages/*.php a4409d26_1@d646a74eb9.nxcli.io:d646a74eb9.nxcli.io/html/pages/

# 4. Clear OpCache
curl https://cforkids.org/clear_cache.php

# 5. Verify in browser console (no CSP errors)
```

## Verification

✅ **Console Check:** No CSP errors in browser console
✅ **Functionality:** All scripts load and execute properly
✅ **Security:** CSP nonce system working as intended
✅ **Performance:** No impact on page load times

## Key Lessons

1. **Variable Scope Matters:** Variables set in included files need explicit `global` declaration
2. **Single Source of Truth:** Nonce should be generated once per request (in config.php)
3. **Testing After OpCache:** PHP OpCache can mask issues - always clear cache when testing
4. **Browser Security Features:** Modern browsers hide nonce attributes from JavaScript (security feature)

## Rollback Plan

If issues arise:

```bash
# Revert to v1.7.3
git checkout v1.7.3
rsync -avz --exclude-from='.rsyncignore' ./ a4409d26_1@d646a74eb9.nxcli.io:d646a74eb9.nxcli.io/html/
```

## Related Issues

- Initial deployment: v1.7.3-DEPLOYMENT-COMPLETE.md
- CSP system design: docs/technical/csp-implementation.md

---

**Deployed by:** Claude Code
**Verified by:** Console testing, functionality verification
**Production URL:** https://cforkids.org
