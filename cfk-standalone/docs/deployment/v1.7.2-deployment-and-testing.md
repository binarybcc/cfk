# v1.7.2 Deployment & Testing Plan

**Release**: v1.7.2
**Date**: October 25, 2025
**Status**: ✅ Deployed to Staging, ⏳ Awaiting Testing

---

## 🎯 What's in v1.7.2

### Critical Database Method Fixes (9 total)

PHPStan static analysis discovered undefined methods that would cause fatal errors:

1. **admin/ajax_handler.php** - `Database::fetchOne()` → `fetchRow()`
2. **admin/import_csv.php** - `Database::query()` → `execute()` (3 occurrences)
3. **includes/email_queue.php** - `Database::query()` → `execute()` (2 occurrences)
4. **includes/backup_manager.php** - `Database::query()` → `execute()` (3 occurrences, deprecated file)

### Plus Previous v1.7.1 Fixes:
- Edit handlers for sponsorships and children
- Name field removal from child forms
- reports.php Database::execute() fix

---

## 📊 Files Deployed

| File | Size | Timestamp | Status |
|------|------|-----------|--------|
| admin/ajax_handler.php | 10K | Oct 25 20:54 | ✅ Deployed |
| admin/import_csv.php | 54K | Oct 25 20:54 | ✅ Deployed |
| includes/email_queue.php | 9.8K | Oct 25 20:54 | ✅ Deployed |
| includes/backup_manager.php | - | Oct 25 20:54 | ✅ Deployed |

---

## 🧪 Staging Testing Checklist

### Test Environment:
**URL**: https://10ce79bd48.nxcli.io/html/admin/

### Test 1: Toggle Child Status (ajax_handler.php fix)
**What was fixed**: `Database::fetchOne()` → `fetchRow()`

**Steps**:
1. Login to staging admin
2. Go to: https://10ce79bd48.nxcli.io/html/admin/manage_children.php
3. Find an "Available" child
4. Click the toggle button to make them "Inactive"
5. ✅ **Expected**: Status changes successfully, no error
6. Toggle back to "Available"
7. ✅ **Expected**: Status changes back successfully

**Result**: [ ] Pass / [ ] Fail

---

### Test 2: Edit Sponsorship (from v1.7.1)
**What was fixed**: Edit handlers added

**Steps**:
1. Go to: https://10ce79bd48.nxcli.io/html/admin/manage_sponsorships.php
2. Click "Edit" on any sponsorship
3. Change sponsor name slightly
4. Click "Update Sponsor"
5. ✅ **Expected**: Modal closes, page reloads, change saved
6. ✅ **Expected**: No "Processing..." stuck button

**Result**: [ ] Pass / [ ] Fail

---

### Test 3: Edit Child (from v1.7.1)
**What was fixed**: Edit handlers added, Name field removed

**Steps**:
1. Go to: https://10ce79bd48.nxcli.io/html/admin/manage_children.php
2. Click "Edit" on any child
3. ✅ **Expected**: Modal opens WITHOUT Name field
4. Change child age
5. Click "Update Child"
6. ✅ **Expected**: Page reloads with updated age
7. ✅ **Expected**: Name field in database unchanged

**Result**: [ ] Pass / [ ] Fail

---

### Test 4: Verify No Fatal Errors

**Steps**:
1. Check browser console for JavaScript errors
2. Check staging error logs for PHP errors:
   ```bash
   ssh ac6c9a98_1@10ce79bd48.nxcli.io "tail -50 /home/ac6c9a98/logs/error.log"
   ```
3. ✅ **Expected**: No fatal errors related to Database methods

**Result**: [ ] Pass / [ ] Fail

---

### Test 5: CSV Import (Optional - High Risk Operation)

**⚠️ WARNING**: This deletes all children! Only test if you have a backup.

**What was fixed**: `Database::query()` → `execute()` in bulk delete

**Steps** (OPTIONAL):
1. Create backup of staging database first
2. Go to: https://10ce79bd48.nxcli.io/html/admin/import_csv.php
3. Upload a CSV file
4. Click "Delete All Children" before import
5. ✅ **Expected**: Bulk delete succeeds without fatal error
6. Proceed with import
7. ✅ **Expected**: Import completes successfully

**Result**: [ ] Pass / [ ] Fail / [ ] Skipped

---

## 🚀 Production Deployment

### Prerequisites:
- [ ] All staging tests passed
- [ ] No console errors
- [ ] No PHP fatal errors in logs
- [ ] User approves deployment

### Production Servers:
- **Host**: d646a74eb9.nxcli.io
- **SSH User**: a4409d26_1
- **Path**: /home/a4409d26/d646a74eb9.nxcli.io/html

### Deployment Commands:

```bash
# 1. Deploy files to production
sshpass -p 'HangerAbodeFicesMoved' scp -o StrictHostKeyChecking=no \
  admin/ajax_handler.php \
  a4409d26_1@d646a74eb9.nxcli.io:/home/a4409d26/d646a74eb9.nxcli.io/html/admin/

sshpass -p 'HangerAbodeFicesMoved' scp -o StrictHostKeyChecking=no \
  admin/import_csv.php \
  a4409d26_1@d646a74eb9.nxcli.io:/home/a4409d26/d646a74eb9.nxcli.io/html/admin/

sshpass -p 'HangerAbodeFicesMoved' scp -o StrictHostKeyChecking=no \
  includes/email_queue.php \
  includes/backup_manager.php \
  a4409d26_1@d646a74eb9.nxcli.io:/home/a4409d26/d646a74eb9.nxcli.io/html/includes/

# 2. Verify deployment
sshpass -p 'HangerAbodeFicesMoved' ssh a4409d26_1@d646a74eb9.nxcli.io \
  "ls -lh /home/a4409d26/d646a74eb9.nxcli.io/html/admin/ajax_handler.php \
           /home/a4409d26/d646a74eb9.nxcli.io/html/admin/import_csv.php \
           /home/a4409d26/d646a74eb9.nxcli.io/html/includes/email_queue.php"

# 3. Quick smoke test
# Visit https://cforkids.org/admin/ and verify login works
```

---

## ✅ Success Criteria

### Deployment Successful If:
1. ✅ All 4 files deployed with fresh timestamps
2. ✅ Toggle child status works without errors
3. ✅ Edit sponsorship modal works correctly
4. ✅ Edit child modal works (no Name field)
5. ✅ No PHP fatal errors in logs
6. ✅ No JavaScript console errors

### ❌ Rollback If:
1. Fatal errors occur
2. Database operations fail
3. Admin functions stop working
4. Any critical functionality breaks

---

## 🔄 Rollback Plan (If Needed)

### Quick Rollback (5 minutes):

```bash
# 1. SSH to production
ssh a4409d26_1@d646a74eb9.nxcli.io

# 2. Navigate to app directory
cd /home/a4409d26/d646a74eb9.nxcli.io/html

# 3. Checkout previous version
git checkout v1.7.1

# 4. Verify rollback
ls -lh admin/ajax_handler.php

# 5. Test site
# Visit https://cforkids.org/admin/
```

---

## 📊 Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Fatal errors | Very Low | High | Rollback plan ready |
| Database failures | Very Low | Medium | Simple method renames |
| Performance issues | Very Low | Low | No logic changes |
| Compatibility | Very Low | Low | Same PHP version |

**Overall Risk**: **VERY LOW** ✅

---

## 🎯 What These Fixes Prevent

### Before v1.7.2 (Production Issues):
❌ Toggle child status → Fatal error `Database::fetchOne()` not found
❌ CSV bulk delete → Fatal error `Database::query()` not found
❌ Email retry cron → Fatal error `Database::query()` not found
❌ Email cleanup cron → Fatal error `Database::query()` not found

### After v1.7.2:
✅ All Database method calls use correct methods
✅ All admin functions work reliably
✅ No risk of fatal errors from undefined methods
✅ PHPStan Level 8 validation passes

---

## 📈 Timeline

| Phase | Duration | Status |
|-------|----------|--------|
| PHPStan Scan | 5 minutes | ✅ Complete |
| Fix Development | 10 minutes | ✅ Complete |
| Staging Deployment | 2 minutes | ✅ Complete |
| Staging Testing | 15 minutes | 🟡 In Progress |
| Production Deployment | 5 minutes | ⏳ Awaiting Approval |
| Production Testing | 10 minutes | ⏳ Pending |

**Total Time**: ~47 minutes from discovery to production

---

## 🎉 Next Steps

1. **NOW**: Test on staging using checklist above
2. **After tests pass**: Approve production deployment
3. **Deploy to production**: Execute deployment commands
4. **Verify production**: Quick smoke test
5. **Monitor**: Watch error logs for 24 hours

---

## 📝 Notes

- **backup_manager.php** is deprecated (early return at line 12), but fixed for completeness
- All fixes are simple method renames - no logic changes
- v1.7.2 includes all v1.7.1 fixes plus these Database method fixes
- PHPStan now scans admin/includes/pages directories (prevents future issues)

---

**Ready for staging testing! Run through the checklist above and report results.**
