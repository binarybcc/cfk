# v1.9 Complete OOP Modernization Plan

**Status**: âœ… APPROVED
**Date Created**: October 25, 2025
**Timeline**: 26 weeks (6 months)
**Branch**: `v1.9-modernization`
**Archon Project ID**: `3cb7d541-7d14-4314-b8d0-61959d30dcef`

---

## ğŸ¯ Core Mission

**Convert all legacy procedural code to modern OOP architecture while preserving 100% of existing functionality. Add minimal Alpine.js polish to improve admin efficiency.**

---

## ğŸš¨ CRITICAL CONSTRAINTS

### âŒ DO NOT CHANGE DATABASE SCHEMA
- **Database structure is CORRECT as-is in production**
- **NO adding fields** (especially NO "name" field to children table)
- **NO removing fields**
- **NO renaming fields**
- Database changes require EXPLICIT approval only
- Children are identified by family code (175B), NOT names

### âœ… What We're Actually Doing
- Modernize CODE structure only
- Keep database schema identical
- Keep all functionality identical
- Add Google Workspace SMTP
- Add minimal Alpine.js admin improvements

---

## ğŸ“‹ Phase-by-Phase Migration

### Phase 1: Foundation (Weeks 1-6)

#### 1.1 Dependency Injection Container
- Implement PHP-DI (lightweight, powerful)
- Service provider registration
- Auto-wiring for common services

#### 1.2 Database Layer Unification
**Current**:
- `includes/database_wrapper.php` (non-namespaced `Database` class)
- `src/Database/Connection.php` (modern PSR-4, not fully used)

**Target**:
- Single `CFK\Infrastructure\Database\DatabaseManager`
- Repository pattern for all data access
- **NO SCHEMA CHANGES** - just code structure

**Repositories**:
- `ChildRepository` (uses existing children table AS-IS)
- `FamilyRepository`
- `SponsorshipRepository`
- `ReservationRepository`
- `EmailLogRepository`

#### 1.3 Enum Migration
Replace string constants with type-safe enums:
- `ChildStatus` (available, reserved, sponsored, archived)
- `SponsorshipStatus`
- `ReservationStatus`
- `EmailStatus`
- `Gender`
- `AvatarCategory`

---

### Phase 2: Core Services (Weeks 7-12)

#### 2.1 Email Service with Google Workspace SMTP
**Current**: PHPMailer with `mail()`
**Target**: PHPMailer with Google Workspace SMTP

**Configuration** (.env):
```ini
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=noreply@cforkids.org
SMTP_PASSWORD=[app password from Google]
SMTP_FROM_EMAIL=noreply@cforkids.org
SMTP_FROM_NAME=Christmas for Kids
```

**Service**:
```php
class EmailService {
    public function __construct(
        private string $smtpHost,
        private int $smtpPort,
        private string $smtpUsername,
        private string $smtpPassword
    ) {}

    public function send(Email $email): bool {
        $mail = new PHPMailer(true);
        $mail->isSMTP();
        $mail->Host = $this->smtpHost;
        // ... configure SMTP
    }
}
```

**Benefits**:
- Better deliverability (~95% vs ~60%)
- Free (already have Google Workspace)
- Sent emails appear in Gmail Sent folder
- 2,000/day limit (need ~7/day average)

**Setup Steps**:
1. Create App Password in Google Workspace
   - Go to Google Account settings
   - Security â†’ 2-Step Verification â†’ App passwords
   - Generate app password for "Mail"
   - Get 16-character password
2. Add to .env file
3. Update EmailService to use SMTP configuration

#### 2.2 Authentication Service
**Current**: Magic link functions in includes/
**Target**: `CFK\Infrastructure\Auth\MagicLinkService`

- Modern OOP structure
- Same magic link workflow
- NO changes to authentication logic

#### 2.3 CSV Handler
**Current**: `src/CSV/Handler.php`
**Target**: Modernized with repository injection

- **NO changes to CSV format**
- **NO changes to field mappings**
- **NO database schema changes**
- Just inject repositories instead of static Database calls

#### 2.4 Reservation System
**Current**: `includes/reservation_functions.php`
**Target**: `CFK\Application\Service\ReservationService`

- Same 2-hour expiration logic
- Same workflow
- Just modern code structure

#### 2.5 Sponsorship Management
**Target**: `CFK\Application\Service\SponsorshipService`

- Consolidate sponsorship logic
- Keep same workflow
- Modern code structure

---

### Phase 3: Admin Controllers (Weeks 13-18)

#### 3.1 Controller Pattern with Attributes
Convert admin/*.php to modern controllers:

**Before** (`admin/manage_children.php`):
```php
<?php
require_once '../includes/database_wrapper.php';
session_start();
// 300 lines of mixed HTML and PHP
```

**After** (`src/Admin/Controller/ChildController.php`):
```php
<?php
namespace CFK\Admin\Controller;

use CFK\Application\Service\ChildService;
use CFK\Infrastructure\Http\Request;
use CFK\Infrastructure\Http\Response;

class ChildController {
    public function __construct(
        private readonly ChildService $childService
    ) {}

    #[Route('/admin/children', methods: ['GET'])]
    public function index(Request $request): Response {
        $children = $this->childService->getAllChildren();
        return view('admin/children/index', ['children' => $children]);
    }

    #[Route('/admin/children/{id}/edit', methods: ['POST'])]
    public function update(Request $request, int $id): Response {
        // Handle update with injected service
    }
}
```

**Admin Controllers**:
- `DashboardController` (admin/index.php)
- `ChildController` (admin/manage_children.php)
- `SponsorshipController` (admin/manage_sponsorships.php)
- `CsvImportController` (admin/import_csv.php)
- `ReportController` (admin/reports.php)
- `AuthController` (admin login/magic-link)

#### 3.2 Minimal Alpine.js Enhancements
**Goal**: Make tedious admin tasks more efficient

**Current tedious workflows** (to improve):
1. **Edit child**: Open modal â†’ edit â†’ submit â†’ page reload â†’ scroll to find child again
2. **Edit sponsorship**: Same issue - loses place after edit
3. **CSV import**: No progress indicator, unclear when done
4. **Bulk operations**: No select-all, manual one-by-one

**Alpine.js improvements**:
```html
<!-- Inline editing without page reload -->
<div x-data="{ editing: false }">
    <div x-show="!editing">
        <span>{{ child.name }}</span>
        <button @click="editing = true">Edit</button>
    </div>

    <form x-show="editing"
          hx-post="/admin/children/{{ child.id }}"
          hx-target="#child-{{ child.id }}"
          @htmx:after-request="editing = false">
        <input name="name" value="{{ child.name }}">
        <button type="submit">Save</button>
        <button @click="editing = false">Cancel</button>
    </form>
</div>
```

**Specific improvements**:
- Inline editing (no modal, no page reload)
- Bulk selection checkboxes
- CSV import progress bar
- Live search/filter (no server roundtrip)
- Success toasts (instead of page reload messages)

**Important**: Keep same UI design, just add interactivity

---

### Phase 4: Public Controllers (Weeks 13-18, parallel)

#### 4.1 Public Page Controllers
Convert pages/*.php to controllers:

**Before** (`pages/children.php`):
```php
<?php
require_once '../includes/database_wrapper.php';
// Direct database calls, mixed HTML/PHP
```

**After** (`src/Public/Controller/ChildrenController.php`):
```php
<?php
namespace CFK\Public\Controller;

class ChildrenController {
    #[Route('/children', methods: ['GET'])]
    public function browse(Request $request): Response {
        $children = $this->childService->getAvailableChildren();
        return view('public/children/browse', ['children' => $children]);
    }
}
```

**Public Controllers**:
- `HomeController`
- `ChildrenController` (browse, individual child)
- `SelectionsController` (shopping cart)
- `ReservationController` (review, confirm)
- `SponsorPortalController` (access via magic link)

#### 4.2 Keep Public UI Identical
- Same HTML structure
- Same CSS classes
- Same user experience
- Just modernize code underneath

---

### Phase 5: Template System (Weeks 19-20)

#### 5.1 Lightweight Template Engine
**Option**: **Plates** (Native PHP templates, easiest migration)

**Before**:
```php
// pages/child.php
<h1><?php echo htmlspecialchars($child['name']); ?></h1>
```

**After**:
```php
// resources/views/public/child/show.php
<h1><?= $this->e($child->name) ?></h1>
```

**Why Plates**:
- Same PHP syntax volunteers understand
- Automatic escaping
- Template inheritance
- Easy migration path
- No new syntax to learn

---

### Phase 6: Testing Infrastructure (Weeks 21-24)

#### 6.1 Unit Tests
**Goal**: 80% coverage for services/repositories

**Example**:
```php
class SponsorshipServiceTest extends TestCase {
    public function test_creates_sponsorship_with_valid_data(): void {
        $service = $this->container->get(SponsorshipService::class);

        $sponsorship = $service->createSponsorship([
            'child_id' => 1,
            'sponsor_email' => 'test@example.com',
            // ...
        ]);

        $this->assertInstanceOf(Sponsorship::class, $sponsorship);
        $this->assertEquals('pending', $sponsorship->status);
    }
}
```

**Test coverage goals**:
- All services: 80%+
- All repositories: 90%+
- Controllers: 60%+ (integration style)

#### 6.2 Integration Tests
- Sponsorship flow end-to-end
- CSV import process
- Magic link authentication
- Reservation expiration

#### 6.3 PHPStan Level 8
- Already running PHPStan Level 8
- Continue enforcing on all new code
- Fix any issues found

---

### Phase 7: Deployment & Documentation (Weeks 25-26)

#### 7.1 Migration Path
**Strategy**: Strangler Fig Pattern (gradual replacement)

1. **Week 25**: Deploy to staging
   - Run alongside v1.8 for comparison
   - Test all features
   - Fix any issues

2. **Week 26**: Production deployment
   - Deploy during off-season (low traffic)
   - Monitor closely
   - Rollback plan ready

#### 7.2 Documentation
- Architecture decision records (ADRs)
- Developer setup guide
- Service diagram
- Database schema documentation
- Admin user guide (if UI changed)

---

## ğŸ“ Final Directory Structure

```
cfk-standalone/
â”œâ”€â”€ public/                      # Web root
â”‚   â”œâ”€â”€ index.php                # Front controller
â”‚   â”œâ”€â”€ assets/
â”‚   â””â”€â”€ .htaccess
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â””â”€â”€ Controller/          # Admin controllers
â”‚   â”œâ”€â”€ Public/
â”‚   â”‚   â””â”€â”€ Controller/          # Public controllers
â”‚   â”œâ”€â”€ Application/
â”‚   â”‚   â”œâ”€â”€ Service/             # Business logic
â”‚   â”‚   â””â”€â”€ DTO/                 # Data transfer objects
â”‚   â”œâ”€â”€ Domain/
â”‚   â”‚   â”œâ”€â”€ Model/               # Domain entities
â”‚   â”‚   â”œâ”€â”€ Repository/          # Repository interfaces + impl
â”‚   â”‚   â”œâ”€â”€ Enum/                # All enums
â”‚   â”‚   â””â”€â”€ ValueObject/         # Email, Money, etc.
â”‚   â”œâ”€â”€ Infrastructure/
â”‚   â”‚   â”œâ”€â”€ Database/            # Database manager
â”‚   â”‚   â”œâ”€â”€ Email/               # Email service (PHPMailer)
â”‚   â”‚   â”œâ”€â”€ Auth/                # Magic link auth
â”‚   â”‚   â”œâ”€â”€ Storage/             # File storage
â”‚   â”‚   â””â”€â”€ Http/                # Request/Response
â”‚   â””â”€â”€ Shared/
â”‚       â”œâ”€â”€ Attribute/           # Route, etc.
â”‚       â”œâ”€â”€ Middleware/          # Auth, CSRF, etc.
â”‚       â””â”€â”€ Exception/           # Custom exceptions
â”œâ”€â”€ resources/
â”‚   â””â”€â”€ views/                   # Plates templates
â”‚       â”œâ”€â”€ admin/
â”‚       â””â”€â”€ public/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ container.php            # DI configuration
â”‚   â”œâ”€â”€ routes.php               # Route definitions
â”‚   â””â”€â”€ services.php             # Service providers
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Unit/
â”‚   â”œâ”€â”€ Integration/
â”‚   â””â”€â”€ fixtures/
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ migrations/              # Phinx migrations
â”‚   â””â”€â”€ schema.sql
â””â”€â”€ [delete these after migration]
    â”œâ”€â”€ admin/                   # Migrated to controllers
    â”œâ”€â”€ pages/                   # Migrated to controllers
    â””â”€â”€ includes/                # Migrated to services
```

---

## ğŸ¯ Modern PHP Features (Scaled Appropriately)

### âœ… Use These:
- **Dependency Injection**: PHP-DI container
- **Enums**: Replace all string constants
- **Typed Properties**: Everywhere
- **Readonly Properties**: For immutable data
- **Constructor Property Promotion**: Less boilerplate
- **Attributes**: For routing (#[Route])
- **Match Expressions**: Replace switch
- **Named Arguments**: Improve readability
- **Repository Pattern**: Clean data access
- **Service Layer**: Business logic separation

### âŒ Don't Overengineer:
- âŒ Full ORM (Doctrine) - too heavy
- âŒ Event Sourcing - unnecessary
- âŒ CQRS - overkill
- âŒ Microservices - monolith is fine
- âŒ Complex event systems - keep simple
- âŒ DDD tactical patterns - too complex for this scale

---

## ğŸ“Š Success Criteria

### Code Quality:
- [ ] Zero files in admin/, pages/, includes/
- [ ] 100% PSR-4 namespaced
- [ ] 80%+ test coverage
- [ ] PHPStan Level 8 clean
- [ ] All dependencies injected

### Functionality:
- [ ] All existing features work identically
- [ ] Magic link auth unchanged
- [ ] Email delivery improved (Google SMTP)
- [ ] CSV import/export unchanged
- [ ] Public pages look/work the same
- [ ] Admin can do everything they could before

### Database:
- [ ] **ZERO schema changes**
- [ ] **NO name field added**
- [ ] All existing fields preserved
- [ ] All relationships maintained

### UX Improvements (Minimal):
- [ ] Inline editing works (no page reloads)
- [ ] Bulk selection available
- [ ] CSV import shows progress
- [ ] Success messages are toasts
- [ ] Search/filter is instant

---

## ğŸ“… Timeline Summary

- **Weeks 1-6**: Foundation (DI, Database, Enums)
- **Weeks 7-12**: Core Services (Email + Google SMTP, Auth, CSV, Reservations)
- **Weeks 13-18**: Controllers (Admin + Public)
- **Weeks 19-20**: Templates (Plates migration)
- **Weeks 21-24**: Testing (Unit + Integration)
- **Weeks 25-26**: Deployment + Documentation

**Total**: 26 weeks (6 months comprehensive)

---

## âœ… What This Achieves

1. **Maintainable Code**: Modern OOP structure, easy to understand
2. **Testable**: DI makes testing straightforward
3. **Type Safe**: Enums + strict types catch bugs early
4. **Efficient Admin**: Small Alpine.js improvements save time
5. **Better Email**: Google Workspace SMTP improves deliverability
6. **Future Ready**: Solid foundation for any future features
7. **100% Feature Parity**: Everything works exactly as before

---

## âŒ What This Does NOT Include

- âŒ No Google SSO for admin login
- âŒ No SendGrid (using Google Workspace SMTP instead)
- âŒ No new features from v2.0 roadmap
- âŒ No UI/UX redesign
- âŒ No public page visual changes
- âŒ No database schema changes
- âŒ Just architecture + minimal admin efficiency improvements

---

## ğŸ“ Phase 1 Tasks (Weeks 1-6)

**Created in Archon** (Project ID: `3cb7d541-7d14-4314-b8d0-61959d30dcef`):

1. âœ… Create v1.9 branch from v1.8-cleanup - **DONE**
2. â³ Install and configure PHP-DI container
3. â³ Create Repository interfaces and base classes
4. â³ Create DatabaseManager service to replace static Database class
5. â³ Create all domain enums
6. â³ Implement ChildRepository with full CRUD operations
7. â³ Implement remaining repositories (Family, Sponsorship, Reservation, EmailLog)
8. â³ Write unit tests for repositories

---

## ğŸš¨ Critical Reminders

1. **Database schema is CORRECT** - don't touch it
2. **Get approval before adding ANY fields**
3. **Children identified by family code, not names**
4. **Google Workspace SMTP only** (no other email providers)
5. **Keep everything working exactly as it does now**
6. **No willy-nilly adding things without approval**

---

**Status**: âœ… **APPROVED**
**Ready to proceed**: Yes
**Next step**: Install and configure PHP-DI container (Task #2)
**Branch**: `v1.9-modernization`
**Created**: October 25, 2025
