# v1.8-cleanup Testing Checklist

**Branch:** `v1.8-cleanup`
**Changes:** Removed 3,624 lines of deprecated wrapper files (9 files)
**Risk Level:** Medium (autoloader/require failures)
**Testing Strategy:** Two-tier (Docker + Staging optional)

## 🎯 Testing Objectives

1. Verify all namespaced classes load correctly via autoloader
2. Confirm backward compatibility aliases work
3. Ensure no broken `require_once` statements
4. Validate cron jobs execute without errors
5. Test critical user workflows end-to-end

---

## 🐳 Tier 1: Docker/OrbStack Testing (Primary)

### Prerequisites

- [ ] OrbStack/Docker is running
- [ ] Containers are started: `docker-compose up -d`
- [ ] On `v1.8-cleanup` branch: `git branch`
- [ ] Enhanced docker-compose.yml is active (production-like PHP settings)

### 1. Automated Verification Script

**Run the automated verification script first:**

```bash
🐳 DOCKER:
chmod +x tests/v1.8-cleanup-verification.sh
./tests/v1.8-cleanup-verification.sh
```

**Expected Result:** All tests pass (100% pass rate)

**If failures occur:**
- Review log: `logs/v1.8-cleanup-verification.log`
- Fix critical issues before proceeding
- Re-run script until clean

---

### 2. Autoloader Testing

**Test 2.1: Verify Classes Load**

```bash
🐳 DOCKER (exec into container):
docker-compose exec web bash

# Inside container:
cd /var/www/html
php -r "
require_once 'config/config.php';

\$classes = [
    'CFK\\Sponsorship\\Manager',
    'CFK\\Auth\\MagicLinkManager',
    'CFK\\Avatar\\Manager',
    'CFK\\CSV\\Handler',
    'CFK\\Archive\\Manager',
    'CFK\\Report\\Manager',
    'CFK\\Backup\\Manager',
    'CFK\\Import\\Analyzer'
];

foreach (\$classes as \$class) {
    if (class_exists(\$class)) {
        echo \"✓ \$class loaded\n\";
    } else {
        echo \"✗ \$class FAILED\n\";
        exit(1);
    }
}
echo \"All classes loaded successfully!\n\";
"
```

**Expected Result:** All 8 classes load without errors

**Test 2.2: Verify Backward Compatibility Aliases**

```bash
php -r "
require_once 'config/config.php';

\$aliases = [
    'CFK_Sponsorship_Manager',
    'MagicLinkManager',
    'CFK_Avatar_Manager',
    'CFK_CSV_Handler',
    'CFK_Archive_Manager',
    'CFK_Report_Manager',
    'CFK_Backup_Manager',
    'CFK_Import_Analyzer'
];

foreach (\$aliases as \$alias) {
    if (class_exists(\$alias)) {
        echo \"✓ \$alias works\n\";
    } else {
        echo \"✗ \$alias FAILED\n\";
        exit(1);
    }
}
echo \"All aliases working!\n\";
"
```

**Expected Result:** All 8 aliases resolve correctly

---

### 3. Cron Job Testing

**Test each cron job manually:**

```bash
🐳 DOCKER (inside container):
cd /var/www/html

# Test 1: Magic Link Cleanup
php cron/cleanup_magic_links.php
echo "Exit code: $?"
cat logs/cron_cleanup_magic_links.log

# Test 2: Portal Token Cleanup
php cron/cleanup_portal_tokens.php
echo "Exit code: $?"

# Test 3: Expired Sponsorships Cleanup
php cron/cleanup_expired_sponsorships.php
echo "Exit code: $?"
```

**Expected Results:**
- [ ] Exit code 0 for all cron jobs
- [ ] No PHP fatal errors in output
- [ ] Log entries created successfully
- [ ] Cron log shows cleanup counts

**Common Issues:**
- ❌ `Class 'CFK_Sponsorship_Manager' not found` → Autoloader not loaded
- ❌ `require_once: No such file` → Broken require statement
- ❌ `Call to undefined method` → Class method changed

---

### 4. Admin Panel Testing

**Test 4.1: Dashboard Load**

1. Navigate to: `http://localhost:8082/admin/`
2. Log in with admin credentials
3. Verify dashboard loads without PHP errors

**Expected Result:**
- [ ] Dashboard displays statistics
- [ ] No PHP warnings/errors visible
- [ ] All numbers populated correctly

**Test 4.2: Manage Children**

1. Navigate to: `http://localhost:8082/admin/manage_children.php`
2. Click "Add New Child"
3. Fill in test data and save

**Expected Result:**
- [ ] Form loads correctly
- [ ] Avatar assignment works (uses `CFK\Avatar\Manager`)
- [ ] Child saves successfully
- [ ] No autoloader errors

**Test 4.3: CSV Import**

1. Navigate to: `http://localhost:8082/admin/import_csv.php`
2. Upload a test CSV file (use `docs/guides/csv-import-guide.md` template)
3. Process import

**Expected Result:**
- [ ] CSV validation works (uses `CFK\CSV\Handler`)
- [ ] Import analyzer runs (uses `CFK\Import\Analyzer`)
- [ ] Children imported successfully
- [ ] No class loading errors

**Test 4.4: Reports**

1. Navigate to: `http://localhost:8082/admin/reports.php`
2. Generate a report (any type)

**Expected Result:**
- [ ] Report loads (uses `CFK\Report\Manager`)
- [ ] Data displays correctly
- [ ] No autoloader failures

**Test 4.5: Manage Sponsorships**

1. Navigate to: `http://localhost:8082/admin/manage_sponsorships.php`
2. View pending sponsorships
3. Approve/reject a test sponsorship

**Expected Result:**
- [ ] Sponsorship manager loads (uses `CFK\Sponsorship\Manager`)
- [ ] Email system works (uses `CFK\Email\Manager`)
- [ ] Status updates save correctly

---

### 5. Public-Facing Pages Testing

**Test 5.1: Browse Children**

1. Navigate to: `http://localhost:8082/?page=children`
2. Search/filter children
3. Select a child to sponsor

**Expected Result:**
- [ ] Page loads without errors
- [ ] Avatar images display (uses `CFK\Avatar\Manager`)
- [ ] Selection adds to cart

**Test 5.2: Reservation Flow**

1. Add multiple children to cart
2. Navigate to: `http://localhost:8082/?page=selections`
3. Confirm reservation
4. Complete sponsorship form

**Expected Result:**
- [ ] Reservation system works (uses `CFK\Sponsorship\Manager`)
- [ ] Email sent successfully
- [ ] Sponsorship created in database

**Test 5.3: Sponsor Portal**

1. Navigate to: `http://localhost:8082/?page=my_sponsorships`
2. Enter email address
3. Request access link

**Expected Result:**
- [ ] Magic link generated (uses `CFK\Auth\MagicLinkManager`)
- [ ] Email sent with link
- [ ] Portal loads with sponsorship details

---

### 6. Error Log Review

**Check Docker logs for PHP errors:**

```bash
🏠 LOCAL:
docker-compose logs web | grep -i "error\|fatal\|warning" > logs/docker-errors.log
cat logs/docker-errors.log
```

**Expected Result:**
- [ ] No fatal errors
- [ ] No class loading failures
- [ ] No undefined method/function errors

**Review PHP error log:**

```bash
🐳 DOCKER:
docker-compose exec web bash
tail -f /var/log/php_errors.log
```

*(Perform admin actions and monitor for real-time errors)*

---

### 7. Functional Test Suite

**Run the existing comprehensive test suite:**

```bash
🏠 LOCAL:
cd /Users/johncorbin/Desktop/projs/cfk/cfk-standalone
./tests/security-functional-tests.sh
```

**Expected Result:**
- [ ] 35/36 tests pass (same as v1.7 baseline)
- [ ] No new failures introduced
- [ ] Security tests still pass

---

## 📊 Docker Testing Results Summary

| Test Category | Status | Notes |
|--------------|--------|-------|
| Automated Verification Script | ☐ Pass / ☐ Fail | |
| Autoloader (Classes) | ☐ Pass / ☐ Fail | |
| Autoloader (Aliases) | ☐ Pass / ☐ Fail | |
| Cron Jobs | ☐ Pass / ☐ Fail | |
| Admin Dashboard | ☐ Pass / ☐ Fail | |
| Manage Children | ☐ Pass / ☐ Fail | |
| CSV Import | ☐ Pass / ☐ Fail | |
| Reports | ☐ Pass / ☐ Fail | |
| Manage Sponsorships | ☐ Pass / ☐ Fail | |
| Browse Children | ☐ Pass / ☐ Fail | |
| Reservation Flow | ☐ Pass / ☐ Fail | |
| Sponsor Portal | ☐ Pass / ☐ Fail | |
| Error Logs | ☐ Clean / ☐ Issues | |
| Functional Tests | ☐ Pass / ☐ Fail | |

**Overall Docker Testing:** ☐ PASS ☐ FAIL

**Date Tested:** _______________
**Tested By:** _______________

---

## 🌐 Tier 2: Nexcess Staging Testing (Optional)

**Only proceed if Docker testing passes completely.**

### Prerequisites

- [ ] Docker testing completed with 100% pass rate
- [ ] Access to Nexcess staging environment
- [ ] Staging database cloned from production
- [ ] v1.8-cleanup branch deployed to staging

### 1. Deploy to Staging

```bash
🏠 LOCAL:
# Deploy via your deployment script
./deploy.sh staging

# OR manually via SFTP/SSH
```

### 2. Staging Environment Verification

**Test 2.1: Environment Check**

```bash
🌐 STAGING (SSH):
cd /path/to/staging/public_html

# Check PHP version
php -v  # Should be 8.2+

# Test autoloader
php -r "
require_once 'config/config.php';
echo 'Autoloader loaded successfully!';
"
```

**Expected Result:** No errors, PHP 8.2+ confirmed

**Test 2.2: File Verification**

```bash
🌐 STAGING:
# Verify deleted files don't exist
ls -la includes/sponsorship_manager.php  # Should error
ls -la includes/email_manager.php        # Should error

# Verify src/ classes exist
ls -la src/Sponsorship/Manager.php       # Should exist
ls -la src/Auth/MagicLinkManager.php     # Should exist
```

### 3. Cron Job Testing (Production Environment)

**Test cron jobs on actual production infrastructure:**

```bash
🌐 STAGING (SSH):
cd /path/to/staging/public_html

# Run each cron manually
php cron/cleanup_magic_links.php
php cron/cleanup_portal_tokens.php
php cron/cleanup_expired_sponsorships.php
```

**Expected Result:**
- [ ] All exit with code 0
- [ ] Logs created in `logs/` directory
- [ ] No email delivery errors (actual SMTP)

### 4. End-to-End User Workflow

**Test 4.1: Complete Sponsorship (Real Email)**

1. Navigate to staging URL: `https://staging.cforkids.org/?page=children`
2. Select children and reserve
3. Complete sponsorship form with **real email address**
4. Check email delivery:
   - [ ] Reservation confirmation email received
   - [ ] Access link email received
   - [ ] Emails render correctly (HTML)
   - [ ] Links work and direct to staging

**Test 4.2: Admin Processing**

1. Log into staging admin: `https://staging.cforkids.org/admin/`
2. Process pending sponsorship
3. Verify email sent to sponsor
4. Check database records

**Expected Result:**
- [ ] All emails delivered via production SMTP
- [ ] Database updates successful
- [ ] No PHP errors in staging logs

### 5. Performance Testing

**Test response times under production-like load:**

```bash
🏠 LOCAL:
# Simple load test (requires Apache Bench)
ab -n 100 -c 10 https://staging.cforkids.org/?page=children
```

**Expected Result:**
- [ ] Average response time < 2 seconds
- [ ] No 500 errors
- [ ] No timeouts

### 6. Staging Log Review

**Check production server error logs:**

```bash
🌐 STAGING (SSH):
tail -100 /path/to/error.log | grep -i "fatal\|error"
```

**Expected Result:**
- [ ] No fatal errors
- [ ] No class loading issues
- [ ] No undefined method errors

---

## 📊 Staging Testing Results Summary

| Test Category | Status | Notes |
|--------------|--------|-------|
| Environment Verification | ☐ Pass / ☐ Fail | |
| File Verification | ☐ Pass / ☐ Fail | |
| Cron Jobs (Production SMTP) | ☐ Pass / ☐ Fail | |
| Email Delivery | ☐ Pass / ☐ Fail | |
| Complete Sponsorship Flow | ☐ Pass / ☐ Fail | |
| Admin Processing | ☐ Pass / ☐ Fail | |
| Performance | ☐ Pass / ☐ Fail | |
| Production Logs | ☐ Clean / ☐ Issues | |

**Overall Staging Testing:** ☐ PASS ☐ FAIL

**Date Tested:** _______________
**Tested By:** _______________

---

## ✅ Final Approval Checklist

Before deploying v1.8-cleanup to production:

- [ ] Docker testing: 100% pass rate
- [ ] Staging testing: 100% pass rate (if applicable)
- [ ] All emails delivered successfully
- [ ] No PHP fatal errors in logs
- [ ] Autoloader works perfectly
- [ ] Cron jobs execute without errors
- [ ] Admin panel fully functional
- [ ] Public pages fully functional
- [ ] Functional test suite passes (35/36)
- [ ] Code reviewed by second developer (optional)
- [ ] Rollback plan prepared (v1.7 tagged and ready)

---

## 🚨 Rollback Procedure (If Issues Found)

If critical issues are discovered during testing:

```bash
🏠 LOCAL:
# Switch back to stable v1.7
git checkout v1.7

# Deploy v1.7 to production
./deploy.sh production

# Document issues in GitHub
# Create detailed issue report for v1.8-cleanup fixes
```

---

## 📝 Testing Notes

**Date:** _______________
**Tester:** _______________
**Environment:** Docker / Staging / Production

**Issues Found:**

---

**Resolution:**

---

**Sign-off:**
☐ Ready for production deployment
☐ Requires fixes before deployment

**Signature:** _______________ **Date:** _______________
