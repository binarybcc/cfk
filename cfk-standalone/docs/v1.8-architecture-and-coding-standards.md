# v1.8 Architecture & Coding Standards

**Branch**: `v1.8-cleanup`
**Date**: October 25, 2025
**Status**: ✅ Confirmed - we are in v1.8-cleanup branch

---

## 🏗️ Architecture Overview

### Dual-Layer Architecture (Transitional)

v1.8 uses a **transitional architecture** where modern PSR-4 classes coexist with legacy procedural code:

```
cfk-standalone/
├── src/                          # ✅ NEW: Modern PSR-4 namespaced classes
│   ├── Database/
│   │   └── Connection.php        # CFK\Database\Connection
│   ├── Sponsorship/
│   │   └── Manager.php           # CFK\Sponsorship\Manager
│   ├── Archive/
│   │   └── Manager.php           # CFK\Archive\Manager
│   └── ... (14 namespaced classes)
│
├── includes/                     # ⚠️ TRANSITIONAL: Legacy layer
│   ├── database_wrapper.php     # OLD: Non-namespaced Database class (STILL USED!)
│   ├── functions.php            # Global helper functions
│   └── email_queue.php          # Legacy utilities
│
└── admin/                        # 🔄 MIXED: Uses BOTH layers
    ├── ajax_handler.php         # Uses: Database (old) + CFK\Sponsorship\Manager (new)
    ├── import_csv.php           # Uses: Database (old) + CFK\CSV\Handler (new)
    └── ...
```

---

## 📋 Current Coding Standards in v1.8

### ✅ Modern Practices (NEW src/ files)

**1. Strict Typing**
```php
<?php
declare(strict_types=1);
```

**2. Namespaces (PSR-4)**
```php
namespace CFK\Database;

use PDO;
use PDOException;
use RuntimeException;
```

**3. Full Type Hints**
```php
/**
 * @param array<string, string> $config
 * @return array<int, array<string, mixed>>
 */
public static function fetchAll(string $sql, array $params = []): array
```

**4. Professional PHPDoc**
```php
/**
 * Execute a query and fetch all results
 *
 * @param string $sql SQL query with placeholders
 * @param array<int|string, mixed> $params Parameters to bind
 * @return array<int, array<string, mixed>> Array of associative arrays
 * @throws PDOException If query fails
 */
```

### ⚠️ Transitional Practices (admin/ and includes/ files)

**1. Strict Typing (Good)**
```php
<?php
declare(strict_types=1);
```

**2. Mixed Class Usage**
```php
// NEW: Import namespaced classes
use CFK\Sponsorship\Manager as SponsorshipManager;

// OLD: Use legacy Database wrapper
Database::fetchRow("SELECT * FROM children WHERE id = ?", [$id]);
```

**3. Partial Type Hints**
```php
// Has return type hints, but missing array type specifications
function editChild(array $data): array  // ⚠️ Should be: array<string, mixed>
```

---

## 🔍 v1.8 Changes from v1.7

### Major Improvements in v1.8:

1. **Deprecated Files DELETED** (3,624 lines removed!)
   - ❌ includes/archive_manager.php
   - ❌ includes/email_manager.php
   - ❌ includes/csv_handler.php
   - ❌ includes/avatar_manager.php
   - ❌ includes/backup_manager.php
   - ❌ includes/report_manager.php
   - ❌ includes/sponsorship_manager.php
   - ❌ includes/import_analyzer.php
   - ❌ includes/magic_link_manager.php

2. **Staging Environment Support**
   - Auto-detection of staging vs production
   - Password bypass for staging
   - Environment badges in admin header
   - Separate .env.staging.example

3. **Bug Fixes**
   - Database::query() → Database::execute() conversions
   - Edit handlers for sponsorships/children
   - Name field removal from children

4. **Docker Improvements**
   - docker-compose.yml updated for staging

---

## 🎯 Database Layer: OLD vs NEW

### OLD Layer (Currently Used by Admin Files)

**File**: `includes/database_wrapper.php`
**Class**: `Database` (non-namespaced)

**Available Methods:**
```php
Database::init(array $config): void
Database::getConnection(): PDO
Database::fetchAll(string $sql, array $params = []): array
Database::fetchRow(string $sql, array $params = []): ?array
Database::execute(string $sql, array $params = []): int
Database::insert(string $table, array $data): int
Database::update(string $table, array $data, array $where): int
Database::delete(string $table, array $where): int
Database::beginTransaction(): void
Database::commit(): void
Database::rollback(): void
```

**❌ METHODS THAT DON'T EXIST (PHPStan caught these!):**
- `Database::query()` - Should use `Database::execute()`
- `Database::fetchOne()` - Should use `Database::fetchRow()`

### NEW Layer (Modern PSR-4)

**File**: `src/Database/Connection.php`
**Class**: `CFK\Database\Connection`

**Same methods as OLD layer, but with:**
- Full PHPDoc type annotations
- Better error messages
- More professional implementation

---

## 📐 Correct Approach for v1.8 Bug Fixes

### ✅ DO: Fix bugs in OLD layer (includes/database_wrapper.php)

Since admin files currently use the OLD Database class, we should:

1. **Fix method calls to use correct methods:**
   ```php
   // WRONG (PHPStan caught these)
   Database::fetchOne(...)  // Doesn't exist
   Database::query(...)     // Doesn't exist

   // CORRECT
   Database::fetchRow(...)  // ✅ Use this
   Database::execute(...)   // ✅ Use this
   ```

2. **Keep using non-namespaced Database class for now**
   ```php
   // Don't change this yet:
   Database::fetchRow("SELECT * FROM children WHERE id = ?", [$id]);
   ```

3. **Follow existing patterns in admin files**
   ```php
   // Mixed usage is OK during transition:
   use CFK\Sponsorship\Manager as SponsorshipManager;  // NEW
   Database::update('sponsorships', [...]);             // OLD
   ```

### ❌ DON'T: Mix layers inconsistently

Don't suddenly change admin files to use `CFK\Database\Connection` while others use `Database`. This would create inconsistency.

---

## 🚀 Migration Path (Future)

**Phase 1 (v1.8)**: Fix bugs in current architecture ✅ WE ARE HERE
**Phase 2 (v1.9?)**: Migrate admin files to use CFK\Database\Connection
**Phase 3 (v2.0?)**: Remove includes/database_wrapper.php entirely

---

## ✅ Verification Checklist

Before making fixes in v1.8, confirm:

- [x] ✅ We are in v1.8-cleanup branch
- [x] ✅ v1.8 uses transitional architecture (src/ + includes/)
- [x] ✅ Admin files use OLD Database class from includes/database_wrapper.php
- [x] ✅ We should fix bugs in the OLD layer (not migrate to NEW yet)
- [x] ✅ Follow existing coding patterns (mixed namespaced + legacy)
- [x] ✅ Use `declare(strict_types=1);` in all PHP files
- [x] ✅ Don't break architectural consistency

---

## 🔧 Recommended Fixes for PHPStan Issues

### Critical Issues (Would Cause Fatal Errors)

1. **ajax_handler.php:135** - `Database::fetchOne()` doesn't exist
   ```php
   // WRONG
   $child = Database::fetchOne("SELECT status FROM children WHERE id = ?", [$childId]);

   // CORRECT (use fetchRow which returns ?array)
   $child = Database::fetchRow("SELECT status FROM children WHERE id = ?", [$childId]);
   ```

2. **import_csv.php:221, 224, 228, 261, 283** - `Database::query()` doesn't exist
   ```php
   // WRONG
   Database::query("TRUNCATE TABLE children");

   // CORRECT
   Database::execute("TRUNCATE TABLE children");
   ```

3. **Add null safety checks** where Database::fetchRow() is used
   ```php
   // BETTER
   $child = Database::fetchRow("SELECT status FROM children WHERE id = ?", [$childId]);
   if (!$child) {
       return ['success' => false, 'message' => 'Child not found'];
   }
   ```

---

## 🎯 Summary: What to Do in v1.8

**YES:**
- Fix `Database::fetchOne()` → `Database::fetchRow()`
- Fix `Database::query()` → `Database::execute()`
- Add null safety checks
- Use `declare(strict_types=1);`
- Follow existing mixed architecture pattern

**NO:**
- Don't migrate admin files to CFK\Database\Connection yet
- Don't change working Database:: calls
- Don't break architectural consistency
- Don't mix different Database layers in same file

---

**Status**: ✅ Ready to proceed with v1.8-compatible bug fixes
