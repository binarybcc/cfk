# v1.9.3 Staging Deployment & Validation Plan

**Created:** 2025-12-17
**Branch:** v1.9.3 â†’ Staging Environment
**Purpose:** Comprehensive plan for deploying and validating v1.9.3 modernization

---

## ðŸ“‹ Overview

This document outlines the complete process for:
1. Deploying v1.9.3 to staging environment
2. Running comprehensive test suite
3. User Acceptance Testing (UAT) protocol
4. Performance and load testing
5. Production readiness checklist

**Status:** ðŸŸ¡ READY TO BEGIN

---

## ðŸŽ¯ Executive Summary

### What We're Deploying

**v1.9.3 Modernization:**
- Complete Slim Framework 4 migration
- 260 files changed (+88,802 lines, -19,835 lines)
- 7 new controllers (MVC architecture)
- 15+ Twig templates
- 40+ RESTful routes
- Enhanced security features
- 96.8% admin code reduction

### Risks & Mitigation

| Risk | Severity | Mitigation |
|------|----------|------------|
| Framework compatibility | Medium | Comprehensive smoke tests |
| Data integrity | High | Database backups before/after |
| Performance degradation | Medium | Load testing protocol |
| Security vulnerabilities | High | Security audit + penetration testing |
| User workflow disruption | Low | 301 redirects for backward compatibility |

---

## ðŸ“¦ STEP 2: Deploy v1.9.3 to Staging

### 2.1 Pre-Deployment Checklist

**Required Before Deployment:**

- [ ] Review v1.9.3 migration documentation
  - `docs/migration/WEEK8-9-MIGRATION-COMPLETE.md`
  - `docs/migration/QUICK-REFERENCE.md`
  - `docs/testing/week8-9-migration-test-plan.md`

- [ ] Verify staging environment configuration
  - `.env.staging` exists and has correct credentials
  - Staging server accessible: `https://10ce79bd48.nxcli.io`
  - SSH access verified

- [ ] Backup current staging database
  ```bash
  # SSH into staging
  source .env.staging
  sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
    "${SSH_USER}@${SSH_HOST}" \
    "cd ${SSH_REMOTE_PATH} && php -r 'require \"config/database.php\"; /* backup script */' > backup_$(date +%Y%m%d_%H%M%S).sql"
  ```

- [ ] Create local rollback point
  ```bash
  git checkout v1.7.3-production-hardening
  git tag staging-rollback-$(date +%Y%m%d)
  ```

### 2.2 Deployment Process

#### Method A: Full Branch Deployment (Recommended for v1.9.3)

**Step 1:** Checkout v1.9.3 locally
```bash
git checkout v1.9.3
git pull origin v1.9.3
```

**Step 2:** Create deployment package
```bash
# Create tarball of entire application
DEPLOY_DATE=$(date +%Y%m%d-%H%M%S)
PACKAGE_NAME="cfk-v1.9.3-staging-${DEPLOY_DATE}.tar.gz"

# Exclude unnecessary files
tar -czf "/tmp/${PACKAGE_NAME}" \
  --exclude='.git*' \
  --exclude='node_modules' \
  --exclude='.DS_Store' \
  --exclude='*.log' \
  --exclude='vendor' \
  --exclude='cache' \
  .

ls -lh "/tmp/${PACKAGE_NAME}"
```

**Step 3:** Upload to staging
```bash
source .env.staging

BASE_USER=$(echo "$SSH_USER" | cut -d'_' -f1)

sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no -P ${SSH_PORT:-22} \
  "/tmp/${PACKAGE_NAME}" \
  "${SSH_USER}@${SSH_HOST}:/home/${BASE_USER}/"
```

**Step 4:** Backup current staging code
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd /home/${BASE_USER} && tar -czf staging-backup-${DEPLOY_DATE}.tar.gz ${SSH_REMOTE_PATH}"
```

**Step 5:** Extract new code
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && tar -xzf /home/${BASE_USER}/${PACKAGE_NAME}"
```

**Step 6:** Install Composer dependencies on server
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && composer install --no-dev --optimize-autoloader"
```

**Step 7:** Set permissions
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && chmod -R 755 . && chmod -R 777 cache"
```

**Step 8:** Clear caches
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && rm -rf cache/twig/*"
```

**Step 9:** Verify deployment
```bash
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && ls -la src/Controller/ && ls -la templates/admin/"
```

### 2.3 Post-Deployment Verification

**Immediate Checks:**

- [ ] Staging URL accessible: `https://10ce79bd48.nxcli.io`
- [ ] Homepage loads without errors
- [ ] Admin login page accessible: `/admin/login`
- [ ] PHP errors check: `tail -100 error_log`
- [ ] Database connection working

**Quick Smoke Test:**
```bash
# Test critical endpoints
curl -I https://10ce79bd48.nxcli.io/
curl -I https://10ce79bd48.nxcli.io/admin/login
curl -I https://10ce79bd48.nxcli.io/children
```

### 2.4 Rollback Procedure (If Needed)

**If deployment fails:**

```bash
source .env.staging

# Restore from backup
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd /home/$(echo $SSH_USER | cut -d'_' -f1) && \
   tar -xzf staging-backup-${DEPLOY_DATE}.tar.gz"

# Restore database if modified
# [Database restore commands]

# Verify rollback
curl -I https://10ce79bd48.nxcli.io/
```

---

## ðŸ§ª STEP 3: Run Full Test Suite

### 3.1 Automated Testing

#### A. Smoke Test (Critical Path Validation)

**Run smoke test from v1.9.3:**
```bash
git checkout v1.9.3
cd tests

# Update BASE_URL for staging
export BASE_URL=https://10ce79bd48.nxcli.io

./smoke-test-admin-migration.sh
```

**Expected Results:**
- All redirect tests pass (301 status codes)
- All route accessibility tests pass (200 status codes)
- Controller files exist
- Template files exist
- Configuration files valid

**Pass Criteria:** 40/40 tests passing

#### B. Security & Functional Tests (Current Test Suite)

**Run existing test suite:**
```bash
cd tests
./security-functional-tests.sh
```

**Expected Results:**
- 35/36 tests passing (1 known failure acceptable)
- CSRF protection working
- Input sanitization working
- SQL injection protection verified
- Session security validated

#### C. Integration Tests

**Database Operations:**
```bash
# Test database connection
curl https://10ce79bd48.nxcli.io/admin/children

# Test data retrieval
# [SQL queries to verify data integrity]
```

**Email System:**
```bash
# Test magic link email
# Verify PHPMailer/SMTP configuration
```

### 3.2 Manual Testing Protocol

**Reference:** `docs/testing/week8-9-migration-test-plan.md`

#### Critical User Journeys

**Journey 1: Admin Authentication**
- [ ] Navigate to `/admin/login`
- [ ] Request magic link with test email
- [ ] Verify email received
- [ ] Click magic link
- [ ] Verify successful login
- [ ] Check session persists
- [ ] Test logout
- [ ] Verify session cleared

**Journey 2: Children Management**
- [ ] Navigate to `/admin/children`
- [ ] Search for a child
- [ ] Filter by status
- [ ] Add new child (full form)
- [ ] Edit existing child
- [ ] Verify avatar assignment
- [ ] Test delete (non-sponsored)

**Journey 3: Sponsorship Processing**
- [ ] View sponsorships list
- [ ] Filter by status
- [ ] Mark as logged
- [ ] Mark as complete
- [ ] Cancel sponsorship
- [ ] Test bulk actions
- [ ] Export to CSV

**Journey 4: CSV Import**
- [ ] Upload valid CSV
- [ ] Review preview
- [ ] Confirm import
- [ ] Verify children created
- [ ] Test backup creation
- [ ] Test restore from backup

**Journey 5: Year-End Reset**
- [ ] View archive page
- [ ] Review current statistics
- [ ] Test reset simulation (if possible)
- [ ] Verify archive creation
- [ ] Test restore (if safe)

#### Browser Compatibility Testing

Test on each browser:
- [ ] Chrome 120+ (Desktop)
- [ ] Firefox 121+ (Desktop)
- [ ] Safari 17+ (Desktop)
- [ ] Edge 120+ (Desktop)
- [ ] Chrome Mobile (iOS)
- [ ] Safari Mobile (iOS)
- [ ] Chrome Mobile (Android)

**Test scenarios per browser:**
1. Login flow
2. Navigate all menu items
3. Create/edit child
4. View sponsorships
5. Responsive design check
6. Form submissions
7. JavaScript functionality

### 3.3 Test Results Documentation

**Create test report:**
```bash
# Create test results file
cat > docs/testing/V1.9.3-STAGING-TEST-RESULTS.md <<EOF
# v1.9.3 Staging Test Results

**Test Date:** $(date +%Y-%m-%d)
**Tested By:** [Your Name]
**Environment:** Staging (10ce79bd48.nxcli.io)

## Automated Tests

### Smoke Tests
- **Result:** [PASS/FAIL]
- **Score:** [X]/40 tests
- **Issues:** [List any failures]

### Security Tests
- **Result:** [PASS/FAIL]
- **Score:** [X]/36 tests
- **Issues:** [List any failures]

## Manual Tests

### Critical Journeys
[Document each journey result]

### Browser Compatibility
[Document each browser result]

## Issues Found
[List all bugs/issues discovered]

## Recommendations
[Next steps]

EOF
```

---

## ðŸ‘¥ STEP 4: User Acceptance Testing (UAT)

### 4.1 UAT Preparation

**Create UAT test accounts:**
```bash
# Admin account for testing
# Editor account for testing
```

**Prepare UAT documentation:**
```bash
cat > docs/testing/V1.9.3-UAT-GUIDE.md <<EOF
# v1.9.3 User Acceptance Testing Guide

## For Admin Users

### What We're Testing
- New Slim Framework admin interface
- Enhanced security features
- Improved user experience
- All existing functionality preserved

### Test Environment
- URL: https://10ce79bd48.nxcli.io/admin/login
- Your test credentials: [provided separately]

### Test Scenarios

1. **Login & Authentication**
   - Request magic link
   - Check email
   - Click link and login
   - Verify you're logged in

2. **Daily Workflow**
   - Add a new child
   - Edit child information
   - Process a sponsorship
   - Run a report

3. **Feedback Collection**
   - What feels different?
   - Are any features missing?
   - Any errors or confusing behavior?
   - Overall impression?

### How to Report Issues
- Take screenshots
- Note exact steps to reproduce
- Send to: [contact email]

EOF
```

### 4.2 UAT Execution

**Week 1: Initial Testing (Internal)**
- [ ] Project owner tests all features
- [ ] Document all findings
- [ ] Prioritize issues (critical/high/medium/low)

**Week 2: Extended Testing (Admin Users)**
- [ ] Invite 2-3 admin users to test
- [ ] Provide UAT guide
- [ ] Schedule feedback sessions
- [ ] Collect structured feedback

**Week 3: Issue Resolution**
- [ ] Fix critical issues
- [ ] Redeploy to staging
- [ ] Retest affected areas
- [ ] Get sign-off from UAT testers

### 4.3 UAT Acceptance Criteria

**Must Pass:**
- [ ] All critical user journeys work
- [ ] No data loss or corruption
- [ ] Performance acceptable (see Step 5)
- [ ] No security vulnerabilities found
- [ ] Users can complete all daily tasks

**Nice to Have:**
- [ ] Users prefer new interface
- [ ] No confusion about navigation
- [ ] Reports are accurate
- [ ] Mobile experience improved

### 4.4 UAT Sign-Off

**Required Approvals:**
- [ ] Project Owner approval
- [ ] Admin User 1 approval
- [ ] Admin User 2 approval
- [ ] Technical validation complete

**Sign-Off Document:**
```markdown
# v1.9.3 UAT Sign-Off

I have tested the v1.9.3 staging environment and approve it for production deployment.

**Name:** ___________________
**Date:** ___________________
**Role:** ___________________

**Critical Issues:** None / [List]
**Recommendations:** [List]
```

---

## âš¡ STEP 5: Performance & Load Testing

### 5.1 Performance Baselines

**Current v1.7.3 Performance (to compare):**

| Metric | Target | Current v1.7.3 |
|--------|--------|----------------|
| Homepage load | < 2s | [measure] |
| Admin dashboard | < 3s | [measure] |
| Children list (100) | < 2s | [measure] |
| CSV import (500) | < 30s | [measure] |
| Database queries | < 100ms | [measure] |
| Concurrent users | 50 users | [measure] |

### 5.2 Performance Testing Tools

#### A. Apache Bench (Quick Load Test)

**Test homepage:**
```bash
ab -n 1000 -c 10 https://10ce79bd48.nxcli.io/
```
- `-n 1000` = 1000 total requests
- `-c 10` = 10 concurrent requests

**Expected Results:**
- Requests per second: > 50
- Time per request: < 200ms (mean)
- Failed requests: 0

**Test admin dashboard:**
```bash
# Note: Requires authentication, may need session cookies
ab -n 500 -c 5 -C "session_id=..." https://10ce79bd48.nxcli.io/admin/dashboard
```

#### B. Load Testing Script

**Create load test:**
```bash
cat > tests/load-test-v1.9.3.sh <<'EOF'
#!/bin/bash

# Load Test for v1.9.3 Staging

BASE_URL="https://10ce79bd48.nxcli.io"
CONCURRENT_USERS=50
REQUESTS_PER_USER=20

echo "Starting load test..."
echo "Concurrent users: $CONCURRENT_USERS"
echo "Requests per user: $REQUESTS_PER_USER"

# Test public pages
echo "Testing public pages..."
ab -n $((CONCURRENT_USERS * REQUESTS_PER_USER)) -c $CONCURRENT_USERS "$BASE_URL/"
ab -n $((CONCURRENT_USERS * REQUESTS_PER_USER)) -c $CONCURRENT_USERS "$BASE_URL/children"

# Test admin pages (requires session)
# [Admin load tests with authentication]

echo "Load test complete!"
EOF

chmod +x tests/load-test-v1.9.3.sh
```

#### C. Database Performance

**Test query performance:**
```bash
# SSH into staging and run queries
sshpass -p "$SSH_PASSWORD" ssh -p ${SSH_PORT:-22} \
  "${SSH_USER}@${SSH_HOST}" \
  "cd ${SSH_REMOTE_PATH} && php -r '
    require \"config/database.php\";

    \$start = microtime(true);
    // Run test queries
    \$end = microtime(true);

    echo \"Query time: \" . (\$end - \$start) . \" seconds\\n\";
  '"
```

### 5.3 Performance Monitoring

**Set up monitoring:**

1. **Server Resource Monitoring**
   ```bash
   # CPU usage
   top -bn1 | grep "Cpu(s)"

   # Memory usage
   free -m

   # Disk I/O
   iostat
   ```

2. **Application Performance**
   - Enable Tracy debugger (dev mode only)
   - Monitor PHP error logs
   - Track slow queries

3. **Browser Performance**
   - Chrome DevTools â†’ Performance tab
   - Measure page load times
   - Check JavaScript execution
   - Monitor network requests

### 5.4 Performance Benchmarks

**Run benchmarks and compare:**

| Test | v1.7.3 Baseline | v1.9.3 Staging | Change | Status |
|------|-----------------|----------------|--------|--------|
| Homepage (cold) | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Homepage (cached) | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Admin Dashboard | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Children List | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Sponsorships List | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| CSV Import (100) | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Database Queries | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |
| Peak Concurrent | [measure] | [measure] | [%] | [âœ…/âš ï¸/âŒ] |

**Pass Criteria:**
- âœ… Performance improved or within 10% of baseline
- âš ï¸ Performance degraded 10-25% (investigate)
- âŒ Performance degraded >25% (block deployment)

### 5.5 Load Testing Scenarios

**Scenario 1: Normal Load**
- 10 concurrent users
- Mixed page requests
- Duration: 10 minutes
- **Expected:** Zero errors, <2s response times

**Scenario 2: Peak Load**
- 50 concurrent users
- Realistic usage pattern
- Duration: 30 minutes
- **Expected:** <5% errors, <5s response times

**Scenario 3: Stress Test**
- 100 concurrent users
- Heavy database operations
- Duration: 15 minutes
- **Expected:** System remains stable, graceful degradation

### 5.6 Performance Issue Resolution

**If performance issues found:**

1. **Identify bottleneck**
   - Profile with Tracy or Xdebug
   - Check slow query log
   - Monitor server resources

2. **Common optimizations**
   - Add database indexes
   - Implement query caching
   - Optimize Twig template rendering
   - Enable OPcache
   - Add CDN for assets

3. **Retest after optimization**
   - Run benchmarks again
   - Verify improvements
   - Document changes

---

## âœ… Production Readiness Checklist

### Technical Validation

- [ ] All automated tests passing (smoke + security)
- [ ] Manual test scenarios completed
- [ ] Browser compatibility verified
- [ ] Performance benchmarks meet criteria
- [ ] Load testing successful
- [ ] Security audit completed
- [ ] Database migrations tested
- [ ] Backup/restore procedures verified
- [ ] Rollback plan documented and tested

### User Acceptance

- [ ] UAT completed by admin users
- [ ] No critical issues outstanding
- [ ] User feedback addressed
- [ ] Training materials prepared (if needed)
- [ ] Sign-off received from stakeholders

### Documentation

- [ ] Migration documentation reviewed
- [ ] Deployment runbook created
- [ ] Rollback procedures documented
- [ ] Test results documented
- [ ] Performance baselines recorded
- [ ] Known issues documented

### Deployment Preparation

- [ ] Production database backup scheduled
- [ ] Maintenance window scheduled (if needed)
- [ ] Rollback criteria defined
- [ ] Monitoring alerts configured
- [ ] Support team briefed
- [ ] Communication plan ready

---

## ðŸ“Š Success Metrics

**Deployment Success:**
- Zero data loss
- <5 minutes downtime (if any)
- All critical features functional
- Performance within acceptable range

**Post-Deployment (Week 1):**
- Zero critical bugs reported
- User satisfaction maintained or improved
- Performance stable
- No security incidents

**Long-term (Month 1):**
- Reduced maintenance burden (96.8% less code)
- Improved developer velocity
- Enhanced security posture
- Positive user feedback

---

## ðŸ“… Estimated Timeline

| Phase | Duration | Dependencies |
|-------|----------|--------------|
| **Step 2: Deployment** | 2-4 hours | Staging access, backups |
| **Step 3: Testing** | 1-2 weeks | Test scripts, test data |
| **Step 4: UAT** | 2-3 weeks | User availability, feedback |
| **Step 5: Performance** | 1 week | Load testing tools, baselines |
| **Final Review** | 1 week | All results compiled |
| **Production Deployment** | 1 day | Stakeholder approval |

**Total Estimated Time:** 6-8 weeks for comprehensive validation

---

## ðŸš¨ Escalation Procedures

**Critical Issues (Blocker):**
- Immediate rollback
- Notify project owner
- Document root cause
- Create fix plan

**High Priority Issues:**
- Schedule fix within 48 hours
- Retest affected areas
- UAT re-validation if needed

**Medium/Low Priority:**
- Track in issue tracker
- Include in next update
- Monitor for escalation

---

## ðŸ“ž Support Contacts

**Project Owner:** [Contact Info]
**Technical Lead:** [Contact Info]
**Hosting Support:** [Hosting Provider]
**Emergency Rollback:** [Instructions]

---

**Document Version:** 1.0
**Last Updated:** 2025-12-17
**Next Review:** After Step 2 completion

---

## ðŸŽ¯ Quick Start Commands

**Deploy to staging:**
```bash
# From v1.7.3 branch
git checkout v1.9.3
git pull origin v1.9.3

# Follow Section 2.2 deployment process
```

**Run tests:**
```bash
cd tests
export BASE_URL=https://10ce79bd48.nxcli.io
./smoke-test-admin-migration.sh
./security-functional-tests.sh
```

**Performance test:**
```bash
ab -n 1000 -c 10 https://10ce79bd48.nxcli.io/
```

**Rollback if needed:**
```bash
# Follow Section 2.4 rollback procedure
```
