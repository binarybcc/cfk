# Database Structure Audit Report
## Version 1.5.1 - Phase 2

**Date:** October 13, 2025
**Branch:** v1.5.1-audit-cleanup
**Purpose:** Database schema analysis and consolidation recommendations

---

## Summary

- **Main Schema:** 5 tables (families, children, sponsorships, admin_users, settings)
- **Migration Tables:** 2 tables (reservations, email_log) - documented but not in main schema
- **Separate SQL Files:** 3 files with additional tables
- **Issue:** Fragmented schema across multiple files
- **Recommendation:** Consolidate into single authoritative schema

---

## 1. Main Schema (database/schema.sql)

### Tables Defined

#### ✅ families
```sql
CREATE TABLE families (
    id INT PRIMARY KEY AUTO_INCREMENT,
    family_number VARCHAR(10) NOT NULL UNIQUE,  -- "175", "176", etc.
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Purpose:** Group siblings together
**Status:** ✅ Active and well-structured
**Indexes:** PRIMARY KEY (id), UNIQUE (family_number)
**Usage:** Referenced by children.family_id

---

#### ✅ children
```sql
CREATE TABLE children (
    id INT PRIMARY KEY AUTO_INCREMENT,
    family_id INT NOT NULL,
    child_letter VARCHAR(1) DEFAULT '',  -- A, B, C for siblings

    -- Basic Information
    age INT NOT NULL,
    grade VARCHAR(20),  -- "Pre-K", "K", "1st", "2nd", etc.
    gender ENUM('M', 'F') NOT NULL,
    school VARCHAR(100),

    -- Physical Details
    shirt_size VARCHAR(10),
    pant_size VARCHAR(10),
    shoe_size VARCHAR(10),
    jacket_size VARCHAR(10),

    -- Personal Information
    interests TEXT,
    wishes TEXT,
    special_needs TEXT,

    -- Status and Metadata
    status ENUM('available', 'pending', 'sponsored', 'inactive') DEFAULT 'available',
    photo_filename VARCHAR(255),
    priority_level ENUM('normal', 'high', 'urgent') DEFAULT 'normal',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (family_id) REFERENCES families(id) ON DELETE CASCADE,
    INDEX idx_status (status),
    INDEX idx_age (age),
    INDEX idx_family (family_id),
    INDEX idx_gender (gender)
);
```

**Purpose:** Core child profile data
**Status:** ✅ Active and comprehensive
**Indexes:** 4 indexes + foreign key
**Missing:** reservation_id and reservation_expires_at (added in migration)

---

#### ✅ sponsorships
```sql
CREATE TABLE sponsorships (
    id INT PRIMARY KEY AUTO_INCREMENT,
    child_id INT NOT NULL,

    -- Sponsor Information
    sponsor_name VARCHAR(100) NOT NULL,
    sponsor_email VARCHAR(255) NOT NULL,
    sponsor_phone VARCHAR(20),
    sponsor_address TEXT,

    -- Sponsorship Details
    status ENUM('pending', 'confirmed', 'completed', 'cancelled') DEFAULT 'pending',
    amount_pledged DECIMAL(10,2),
    gift_preference ENUM('shopping', 'gift_card', 'cash_donation') DEFAULT 'shopping',
    special_message TEXT,

    -- Tracking
    request_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    confirmation_date TIMESTAMP NULL,
    completion_date TIMESTAMP NULL,
    notes TEXT,

    FOREIGN KEY (child_id) REFERENCES children(id) ON DELETE CASCADE,
    INDEX idx_status (status),
    INDEX idx_child (child_id),
    INDEX idx_sponsor_email (sponsor_email),
    INDEX idx_request_date (request_date)
);
```

**Purpose:** Track confirmed sponsorships
**Status:** ✅ Active and well-indexed
**Indexes:** 4 indexes + foreign key
**Usage:** Core sponsorship tracking

---

#### ✅ admin_users
```sql
CREATE TABLE admin_users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    reset_token VARCHAR(255) DEFAULT NULL,
    reset_token_expiry DATETIME DEFAULT NULL,
    email VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    role ENUM('admin', 'editor') DEFAULT 'editor',
    last_login TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_username (username),
    INDEX idx_reset_token (reset_token)
);
```

**Purpose:** Admin authentication
**Status:** ✅ Active with password reset support
**Indexes:** 2 indexes
**Security:** ✅ bcrypt password hashing

**Note:** Includes reset_token columns (added via database/add_password_reset_columns.sql)

---

#### ✅ settings
```sql
CREATE TABLE settings (
    setting_key VARCHAR(100) PRIMARY KEY,
    setting_value TEXT,
    description VARCHAR(255),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Purpose:** Application configuration
**Status:** ✅ Active key-value store
**Default Settings:** 7 settings pre-populated
**Usage:** Site configuration management

---

## 2. Migration Files (migrations/)

### ✅ 002_create_reservations_table.sql

**Created:** v1.5 Reservation System

```sql
CREATE TABLE IF NOT EXISTS reservations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    reservation_token VARCHAR(64) UNIQUE NOT NULL,

    -- Sponsor Information
    sponsor_name VARCHAR(255) NOT NULL,
    sponsor_email VARCHAR(255) NOT NULL,
    sponsor_phone VARCHAR(20) DEFAULT NULL,
    sponsor_address TEXT DEFAULT NULL,

    -- Reservation Data
    children_ids TEXT NOT NULL COMMENT 'JSON array of child IDs',
    total_children INT NOT NULL DEFAULT 0,

    -- Status and Timestamps
    status ENUM('pending', 'confirmed', 'expired', 'cancelled') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    confirmed_at TIMESTAMP NULL,
    cancelled_at TIMESTAMP NULL,

    -- Additional Information
    notes TEXT DEFAULT NULL,
    ip_address VARCHAR(45) DEFAULT NULL,
    user_agent VARCHAR(255) DEFAULT NULL,

    INDEX idx_token (reservation_token),
    INDEX idx_email (sponsor_email),
    INDEX idx_status (status),
    INDEX idx_expires (expires_at),
    INDEX idx_created (created_at)
);

-- Add to children table
ALTER TABLE children
ADD COLUMN reservation_id INT DEFAULT NULL AFTER status,
ADD COLUMN reservation_expires_at TIMESTAMP NULL AFTER reservation_id,
ADD INDEX idx_reservation (reservation_id),
ADD FOREIGN KEY fk_child_reservation (reservation_id)
    REFERENCES reservations(id)
    ON DELETE SET NULL
    ON UPDATE CASCADE;
```

**Purpose:** Time-limited child selections (v1.5 feature)
**Status:** ✅ Active and critical for current workflow
**Missing from:** Main schema.sql
**Recommendation:** Add to authoritative schema

---

### ✅ 003_update_email_log_for_reservations.sql

**Purpose:** Update email_log table for reservation emails
**Status:** ✅ Migration for existing table
**Depends on:** email_log table (defined separately)

---

## 3. Separate SQL Files

### ⚠️ database/email_queue_table.sql

```sql
CREATE TABLE IF NOT EXISTS email_queue (
    id INT AUTO_INCREMENT PRIMARY KEY,
    recipient_email VARCHAR(255) NOT NULL,
    recipient_name VARCHAR(255),
    subject VARCHAR(255) NOT NULL,
    body_html TEXT NOT NULL,
    body_text TEXT,

    -- Priority and scheduling
    priority ENUM('high', 'normal', 'low') DEFAULT 'normal',
    scheduled_for TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- Status tracking
    status ENUM('pending', 'processing', 'sent', 'failed') DEFAULT 'pending',
    attempts INT DEFAULT 0,
    max_attempts INT DEFAULT 3,
    last_attempt_at TIMESTAMP NULL,
    sent_at TIMESTAMP NULL,
    error_message TEXT,

    -- Metadata
    email_type VARCHAR(50),
    related_id INT,
    headers JSON,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_status (status),
    INDEX idx_scheduled (scheduled_for),
    INDEX idx_priority (priority),
    INDEX idx_type (email_type)
);
```

**Purpose:** Queued email sending
**Status:** ⚠️ Unclear if active (separate file, not in main schema)
**Usage:** Referenced by includes/email_queue.php
**Recommendation:** Verify usage and add to main schema if active

---

### ⚠️ database/email_log_table.sql

```sql
CREATE TABLE IF NOT EXISTS email_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    recipient_email VARCHAR(255) NOT NULL,
    recipient_name VARCHAR(255),
    subject VARCHAR(255) NOT NULL,

    -- Delivery tracking
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('sent', 'failed', 'bounced') DEFAULT 'sent',
    error_message TEXT,

    -- Metadata
    email_type VARCHAR(50),
    related_id INT,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),

    INDEX idx_email (recipient_email),
    INDEX idx_sent (sent_at),
    INDEX idx_status (status),
    INDEX idx_type (email_type)
);
```

**Purpose:** Email delivery history
**Status:** ⚠️ Separate file, not in main schema
**Usage:** Referenced by email_manager.php and reservation_emails.php
**Recommendation:** Add to main schema (appears to be active)

---

### ⚠️ database/add_password_reset_columns.sql

```sql
ALTER TABLE admin_users
ADD COLUMN reset_token VARCHAR(255) DEFAULT NULL,
ADD COLUMN reset_token_expiry DATETIME DEFAULT NULL,
ADD INDEX idx_reset_token (reset_token);
```

**Purpose:** Add password reset to admin_users
**Status:** ✅ Already in main schema (admin_users table has these columns)
**Recommendation:** Remove this file (redundant)

---

### database/migrations/002_remove_name_column.sql

```sql
ALTER TABLE children DROP COLUMN IF EXISTS name;
```

**Purpose:** Privacy cleanup (v2.0) - remove PII
**Status:** ✅ Historical migration
**Recommendation:** Keep for reference

---

## 4. Schema Fragmentation Issues

### Current State

**Problem:** Tables defined in 4 different locations:

1. `database/schema.sql` - Main schema (5 tables)
2. `migrations/002_create_reservations_table.sql` - reservations table
3. `database/email_queue_table.sql` - email_queue table
4. `database/email_log_table.sql` - email_log table

**Consequences:**
- ❌ Unclear what the "real" schema is
- ❌ Fresh database setup unclear (which files to run?)
- ❌ Developer confusion
- ❌ Documentation gap

---

## 5. Missing Information

### Unknown Status

Need to verify in production:

1. **reservations table** - Is it actually created? (Migration file exists)
2. **email_queue table** - Active or planned? (Separate SQL file)
3. **email_log table** - Active or planned? (Separate SQL file)
4. **children.reservation_id** - Column added? (Migration alters table)
5. **children.reservation_expires_at** - Column added? (Migration alters table)

**Verification Needed:**
```sql
SHOW TABLES;
DESCRIBE children;
DESCRIBE reservations;
DESCRIBE email_log;
DESCRIBE email_queue;
```

---

## 6. Index Analysis

### Well-Indexed Tables ✅

**families**
- PRIMARY KEY (id)
- UNIQUE (family_number)

**children**
- PRIMARY KEY (id)
- INDEX idx_status (status) ✅
- INDEX idx_age (age) ✅
- INDEX idx_family (family_id) ✅
- INDEX idx_gender (gender) ✅
- FOREIGN KEY (family_id) ✅

**sponsorships**
- PRIMARY KEY (id)
- INDEX idx_status (status) ✅
- INDEX idx_child (child_id) ✅
- INDEX idx_sponsor_email (sponsor_email) ✅
- INDEX idx_request_date (request_date) ✅
- FOREIGN KEY (child_id) ✅

**reservations**
- PRIMARY KEY (id)
- UNIQUE (reservation_token) ✅
- INDEX idx_token (reservation_token) ✅
- INDEX idx_email (sponsor_email) ✅
- INDEX idx_status (status) ✅
- INDEX idx_expires (expires_at) ✅ CRITICAL for cleanup cron
- INDEX idx_created (created_at) ✅

### Potential Missing Indexes

**admin_users**
- ✅ Has idx_username
- ✅ Has idx_reset_token
- Consider: INDEX on email (for lookups)

**email_queue** (if active)
- ✅ Has idx_status, idx_scheduled, idx_priority
- Good indexing for queue processing

**email_log** (if active)
- ✅ Has idx_email, idx_sent, idx_status, idx_type
- Well-indexed for queries

**No critical missing indexes identified**

---

## 7. Foreign Key Relationships

### Current Relationships

```
families (1) ──< children (many)
  └─ id ──> family_id [ON DELETE CASCADE]

children (1) ──< sponsorships (many)
  └─ id ──> child_id [ON DELETE CASCADE]

reservations (1) ──< children (many)
  └─ id ──> reservation_id [ON DELETE SET NULL]
```

### Cascading Deletes ✅

**families → children**: ON DELETE CASCADE
- ✅ Appropriate: Delete family, delete all children

**children → sponsorships**: ON DELETE CASCADE
- ✅ Appropriate: Delete child, delete all sponsorships

**reservations → children**: ON DELETE SET NULL
- ✅ Appropriate: Delete reservation, clear child's reservation_id
- Allows child to become available again

**No issues with foreign key relationships**

---

## 8. Data Type Analysis

### Appropriate Types ✅

**IDs:** INT AUTO_INCREMENT ✅
**Names/Text:** VARCHAR with reasonable limits ✅
**Large Text:** TEXT for interests, wishes, notes ✅
**Enums:** Used appropriately for status fields ✅
**Timestamps:** Proper use of TIMESTAMP vs DATETIME ✅
**Decimal:** DECIMAL(10,2) for amount_pledged ✅

### Potential Improvements

**children.photo_filename**
- Currently: VARCHAR(255)
- Not used: Avatar system doesn't use this
- Recommendation: Document as unused or remove in v2.0

**sponsorships.amount_pledged**
- Currently: DECIMAL(10,2)
- Usage: Unclear if tracking amounts
- Recommendation: Verify if needed

---

## 9. Naming Consistency

### Consistent Patterns ✅

**Primary Keys:** All use `id` INT
**Timestamps:** created_at, updated_at, sent_at, etc.
**Foreign Keys:** Descriptive (family_id, child_id, reservation_id)
**Enums:** Lowercase with underscores (gift_card, cash_donation)
**Status Fields:** All named `status` ENUM

**No naming inconsistencies found**

---

## 10. Recommendations

### Priority 1: Schema Consolidation

**Action:** Create single authoritative schema file

**Recommendation:** `database/schema-complete.sql`

Include:
1. All 5 main tables (families, children, sponsorships, admin_users, settings)
2. reservations table (from migrations/002)
3. email_log table (from database/email_log_table.sql)
4. email_queue table (from database/email_queue_table.sql - if active)

**Benefits:**
- ✅ Single source of truth
- ✅ Fresh database setup is clear
- ✅ Documentation is accurate
- ✅ Developer onboarding improved

---

### Priority 2: Production Verification

**Before consolidation, verify:**

```bash
# Check which tables actually exist
mysql -u user -p cfk_db -e "SHOW TABLES;"

# Check children table structure
mysql -u user -p cfk_db -e "DESCRIBE children;"

# Verify reservation columns exist
mysql -u user -p cfk_db -e "SHOW COLUMNS FROM children LIKE 'reservation%';"
```

---

### Priority 3: Migration Documentation

**Action:** Create `database/README.md`

**Contents:**
```markdown
# Database Schema

## Fresh Installation
Run: `database/schema-complete.sql`

## Existing Installation
Run migrations in order:
1. migrations/002_create_reservations_table.sql (if not already run)
2. migrations/003_update_email_log_for_reservations.sql (if email_log exists)

## Schema History
- v1.0: Initial schema (families, children, sponsorships, admin_users, settings)
- v1.5: Reservation system (reservations table + children.reservation_id)
- v2.0: Privacy cleanup (remove children.name column)
```

---

### Priority 4: Cleanup

**Files to Remove:**
- `database/add_password_reset_columns.sql` (redundant - already in main schema)

**Files to Document:**
- `database/migrations/002_remove_name_column.sql` (historical, v2.0 privacy)

---

## 11. Performance Notes

### Query Performance ✅

All critical queries have proper indexes:

**Child Browsing:**
```sql
WHERE status = 'available'  -- idx_status
  AND age BETWEEN ? AND ?    -- idx_age
  AND gender = ?             -- idx_gender
```

**Reservation Cleanup:**
```sql
WHERE expires_at < NOW()     -- idx_expires ✅
  AND status = 'pending'     -- idx_status ✅
```

**Sponsor Lookup:**
```sql
WHERE sponsor_email = ?      -- idx_sponsor_email ✅
```

**No performance issues identified**

---

## 12. Security Considerations

### ✅ Good Practices

- Password hashing (bcrypt) in admin_users
- No PII stored unnecessarily (privacy-first design)
- Foreign key constraints prevent orphaned records
- Indexes don't expose sensitive data

### ⚠️ Consider

- email_log and email_queue store email addresses
- Consider data retention policy
- Consider GDPR compliance (if applicable)

---

## Conclusion

**Database structure is solid** but schema is **fragmented across multiple files**.

**Primary Issue:** Unclear "source of truth" for complete schema

**Recommended Action:** Consolidate all tables into single `database/schema-complete.sql`

**No structural issues found - only organizational improvements needed**
