# Security Action Plan - v1.5.1
## Quick Reference for Implementing Security Recommendations

**Created:** October 13, 2025
**Priority Order:** HIGH ‚Üí MEDIUM ‚Üí LOW

---

## üö® HIGH PRIORITY (Do These First)

### 1. Remove Production Database Password from Source Code ‚è±Ô∏è 30 min

**Current Issue:**
```php
// config/config.php:25
'password' => $isProduction ? 'Fests42Cue50Fennel56Auk46' : 'root'  // ‚ùå EXPOSED
```

**Fix:**
```bash
# 1. Create .env file on server (NOT in git)
cd /path/to/application
cat > .env << 'EOF'
DB_HOST=localhost
DB_NAME=a4409d26_509946
DB_USER=a4409d26_509946
DB_PASSWORD=Fests42Cue50Fennel56Auk46

SMTP_USERNAME=your_smtp_user
SMTP_PASSWORD=your_smtp_password
EOF

chmod 600 .env  # Restrict access
```

**Update config.php:**
```php
// Load .env file
if (file_exists(__DIR__ . '/../.env')) {
    $env = parse_ini_file(__DIR__ . '/../.env');
    foreach ($env as $key => $value) {
        putenv("$key=$value");
    }
}

// Use environment variables
$dbConfig = [
    'host' => getenv('DB_HOST') ?: 'localhost',
    'database' => getenv('DB_NAME') ?: 'cfk_sponsorship_dev',
    'username' => getenv('DB_USER') ?: 'root',
    'password' => getenv('DB_PASSWORD') ?: 'root'
];
```

**Verify .gitignore includes:**
```gitignore
.env
.env.local
.env.production
```

---

### 2. Force Default Admin Password Change ‚è±Ô∏è 45 min

**Issue:** Default password `admin123` in schema.sql

**Fix - Add password change requirement:**

```php
// admin/index.php (after login check)
$admin = Database::fetchRow(
    "SELECT * FROM admin_users WHERE id = ?",
    [$_SESSION['cfk_admin_id']]
);

// Check if using default password
if ($admin['username'] === 'admin' && $admin['created_at'] === $admin['updated_at']) {
    $_SESSION['force_password_change'] = true;
    header('Location: change_password.php');
    exit;
}
```

**Create admin/change_password.php:**
```php
<?php
define('CFK_APP', true);
session_start();
require_once __DIR__ . '/../config/config.php';
require_once __DIR__ . '/../includes/functions.php';

if (!isLoggedIn()) {
    header('Location: login.php');
    exit;
}

if ($_POST) {
    $currentPassword = $_POST['current_password'] ?? '';
    $newPassword = $_POST['new_password'] ?? '';
    $confirmPassword = $_POST['confirm_password'] ?? '';

    // Verify CSRF
    if (!verifyCsrfToken($_POST['csrf_token'] ?? '')) {
        $error = 'Security token invalid';
    }
    // Validate passwords match
    elseif ($newPassword !== $confirmPassword) {
        $error = 'Passwords do not match';
    }
    // Check minimum length
    elseif (strlen($newPassword) < 8) {
        $error = 'Password must be at least 8 characters';
    }
    else {
        // Verify current password
        $admin = Database::fetchRow(
            "SELECT password_hash FROM admin_users WHERE id = ?",
            [$_SESSION['cfk_admin_id']]
        );

        if (password_verify($currentPassword, $admin['password_hash'])) {
            // Update password
            Database::update('admin_users',
                ['password_hash' => password_hash($newPassword, PASSWORD_DEFAULT)],
                ['id' => $_SESSION['cfk_admin_id']]
            );

            unset($_SESSION['force_password_change']);
            header('Location: index.php');
            exit;
        } else {
            $error = 'Current password incorrect';
        }
    }
}
?>
<!-- Add form HTML here -->
```

---

### 3. Implement Portal Token Database Storage ‚è±Ô∏è 2 hours

**Issue:** Portal access tokens stored in PHP sessions (can't revoke)

**Fix - Create tokens table:**

```sql
-- Run this migration
CREATE TABLE portal_access_tokens (
    id INT PRIMARY KEY AUTO_INCREMENT,
    token_hash VARCHAR(255) NOT NULL UNIQUE,
    sponsor_email VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used_at TIMESTAMP NULL,
    revoked_at TIMESTAMP NULL,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_token_hash (token_hash),
    INDEX idx_sponsor_email (sponsor_email),
    INDEX idx_expires_at (expires_at)
);
```

**Update includes/sponsorship_manager.php:**

```php
public static function generatePortalToken(string $email): string {
    $token = bin2hex(random_bytes(32));
    $tokenHash = password_hash($token, PASSWORD_DEFAULT);
    $expiresAt = date('Y-m-d H:i:s', strtotime('+30 minutes'));

    // Store in database
    Database::insert('portal_access_tokens', [
        'token_hash' => $tokenHash,
        'sponsor_email' => $email,
        'expires_at' => $expiresAt,
        'ip_address' => $_SERVER['REMOTE_ADDR'] ?? null,
        'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null
    ]);

    return $token;  // Return plain token (only sent via email once)
}

public static function verifyPortalToken(string $token): array {
    if (empty($token)) {
        return ['valid' => false, 'message' => 'Access token is required.', 'email' => null];
    }

    // Get recent tokens (within last 24 hours)
    $recentTokens = Database::fetchAll(
        "SELECT * FROM portal_access_tokens
         WHERE expires_at > NOW()
         AND used_at IS NULL
         AND revoked_at IS NULL
         AND created_at > DATE_SUB(NOW(), INTERVAL 24 HOUR)
         ORDER BY created_at DESC"
    );

    // Check token against each hash
    foreach ($recentTokens as $tokenRecord) {
        if (password_verify($token, $tokenRecord['token_hash'])) {
            // Check expiration
            if (strtotime($tokenRecord['expires_at']) < time()) {
                return [
                    'valid' => false,
                    'message' => 'Access token has expired. Please request a new access link.',
                    'email' => null
                ];
            }

            // Mark as used
            Database::update('portal_access_tokens',
                ['used_at' => date('Y-m-d H:i:s')],
                ['id' => $tokenRecord['id']]
            );

            return [
                'valid' => true,
                'message' => 'Token valid',
                'email' => $tokenRecord['sponsor_email']
            ];
        }
    }

    return [
        'valid' => false,
        'message' => 'Invalid or expired access token.',
        'email' => null
    ];
}

// Add token revocation method
public static function revokePortalToken(string $email): bool {
    try {
        Database::update('portal_access_tokens',
            ['revoked_at' => date('Y-m-d H:i:s')],
            ['sponsor_email' => $email]
        );
        return true;
    } catch (Exception $e) {
        error_log('Failed to revoke portal tokens: ' . $e->getMessage());
        return false;
    }
}
```

---

## ‚ö†Ô∏è MEDIUM PRIORITY (Next Sprint)

### 4. Add Login Rate Limiting ‚è±Ô∏è 1 hour

**Create includes/rate_limiter.php:**

```php
<?php
declare(strict_types=1);

if (!defined('CFK_APP')) {
    die('Direct access not permitted');
}

class RateLimiter {
    private const MAX_ATTEMPTS = 5;
    private const LOCKOUT_TIME = 900; // 15 minutes

    public static function checkLoginAttempt(string $identifier): bool {
        $key = self::getKey($identifier);

        if (!isset($_SESSION[$key])) {
            $_SESSION[$key] = ['attempts' => 0, 'lockout_until' => null];
        }

        $data = $_SESSION[$key];

        // Check if locked out
        if ($data['lockout_until'] && time() < $data['lockout_until']) {
            $remainingTime = ceil(($data['lockout_until'] - time()) / 60);
            return false; // Still locked out
        }

        // Reset if lockout expired
        if ($data['lockout_until'] && time() >= $data['lockout_until']) {
            $_SESSION[$key] = ['attempts' => 0, 'lockout_until' => null];
        }

        return true; // Allowed to attempt
    }

    public static function recordFailedAttempt(string $identifier): void {
        $key = self::getKey($identifier);

        if (!isset($_SESSION[$key])) {
            $_SESSION[$key] = ['attempts' => 0, 'lockout_until' => null];
        }

        $_SESSION[$key]['attempts']++;

        // Lock out after max attempts
        if ($_SESSION[$key]['attempts'] >= self::MAX_ATTEMPTS) {
            $_SESSION[$key]['lockout_until'] = time() + self::LOCKOUT_TIME;
            error_log("Rate limit: User $identifier locked out for " . self::LOCKOUT_TIME . " seconds");
        }
    }

    public static function recordSuccessfulAttempt(string $identifier): void {
        $key = self::getKey($identifier);
        unset($_SESSION[$key]); // Clear on successful login
    }

    public static function getRemainingLockoutTime(string $identifier): int {
        $key = self::getKey($identifier);

        if (!isset($_SESSION[$key]) || !$_SESSION[$key]['lockout_until']) {
            return 0;
        }

        $remaining = $_SESSION[$key]['lockout_until'] - time();
        return max(0, $remaining);
    }

    private static function getKey(string $identifier): string {
        return 'rate_limit_' . md5($identifier);
    }
}
```

**Update admin/login.php:**

```php
require_once __DIR__ . '/../includes/rate_limiter.php';

// Before checking credentials
$identifier = sanitizeString($_POST['username'] ?? '') . '_' . ($_SERVER['REMOTE_ADDR'] ?? 'unknown');

if (!RateLimiter::checkLoginAttempt($identifier)) {
    $remainingTime = ceil(RateLimiter::getRemainingLockoutTime($identifier) / 60);
    $error = "Too many failed attempts. Please try again in $remainingTime minute(s).";
} else {
    // Existing login logic...

    if ($user && password_verify($password, $user['password_hash'])) {
        RateLimiter::recordSuccessfulAttempt($identifier);
        // Success handling...
    } else {
        RateLimiter::recordFailedAttempt($identifier);
        $error = 'Invalid username or password.';
    }
}
```

---

### 5. Implement Remember-Me Token Validation ‚è±Ô∏è 1.5 hours

**Migration:**

```sql
ALTER TABLE admin_users ADD COLUMN remember_token VARCHAR(255) DEFAULT NULL;
ALTER TABLE admin_users ADD COLUMN remember_token_expires TIMESTAMP NULL;
ALTER TABLE admin_users ADD INDEX idx_remember_token (remember_token);
```

**Update admin/login.php:**

```php
// After successful login
if ($rememberMe) {
    $token = bin2hex(random_bytes(32));
    $tokenHash = password_hash($token, PASSWORD_DEFAULT);
    $expires = date('Y-m-d H:i:s', strtotime('+30 days'));

    // Store hashed token
    Database::update('admin_users',
        [
            'remember_token' => $tokenHash,
            'remember_token_expires' => $expires
        ],
        ['id' => $user['id']]
    );

    // Set cookie with plain token
    setcookie('cfk_remember_token', $token, time() + (30 * 24 * 60 * 60), '/', '', true, true);
}
```

**Add to index.php (before requireLogin):**

```php
// Check remember-me token if not logged in
if (!isLoggedIn() && isset($_COOKIE['cfk_remember_token'])) {
    $token = $_COOKIE['cfk_remember_token'];

    $users = Database::fetchAll(
        "SELECT * FROM admin_users
         WHERE remember_token IS NOT NULL
         AND remember_token_expires > NOW()"
    );

    foreach ($users as $user) {
        if (password_verify($token, $user['remember_token'])) {
            // Auto-login
            $_SESSION['cfk_admin_id'] = $user['id'];
            $_SESSION['cfk_admin_username'] = $user['username'];
            $_SESSION['cfk_admin_role'] = $user['role'];
            break;
        }
    }
}
```

---

### 6. Add PII Access Logging ‚è±Ô∏è 2 hours

**Migration:**

```sql
CREATE TABLE access_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    admin_id INT,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),  -- 'sponsorship', 'child', 'report'
    resource_id INT,
    ip_address VARCHAR(45),
    user_agent VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (admin_id) REFERENCES admin_users(id) ON DELETE SET NULL,
    INDEX idx_admin_id (admin_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);
```

**Create includes/access_logger.php:**

```php
<?php
declare(strict_types=1);

if (!defined('CFK_APP')) {
    die('Direct access not permitted');
}

class AccessLogger {
    public static function log(string $action, string $resourceType = null, int $resourceId = null): void {
        try {
            Database::insert('access_log', [
                'admin_id' => $_SESSION['cfk_admin_id'] ?? null,
                'action' => $action,
                'resource_type' => $resourceType,
                'resource_id' => $resourceId,
                'ip_address' => $_SERVER['REMOTE_ADDR'] ?? null,
                'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? null
            ]);
        } catch (Exception $e) {
            error_log('Failed to log access: ' . $e->getMessage());
        }
    }
}
```

**Use in admin pages:**

```php
// admin/manage_sponsorships.php
require_once __DIR__ . '/../includes/access_logger.php';

// When viewing sponsorship details
$sponsorshipId = sanitizeInt($_GET['id'] ?? 0);
if ($sponsorshipId) {
    AccessLogger::log('view_sponsorship', 'sponsorship', $sponsorshipId);
    $sponsorship = Database::fetchRow(...);
}

// When exporting data
if (isset($_POST['export'])) {
    AccessLogger::log('export_sponsorships', 'report', null);
}
```

---

## üìã LOW PRIORITY (Optional Improvements)

### 7. Add Password Complexity Requirements ‚è±Ô∏è 30 min

```php
// includes/functions.php
function validatePasswordStrength(string $password): array {
    $errors = [];

    if (strlen($password) < 8) {
        $errors[] = 'Password must be at least 8 characters';
    }
    if (!preg_match('/[A-Z]/', $password)) {
        $errors[] = 'Password must contain at least one uppercase letter';
    }
    if (!preg_match('/[a-z]/', $password)) {
        $errors[] = 'Password must contain at least one lowercase letter';
    }
    if (!preg_match('/[0-9]/', $password)) {
        $errors[] = 'Password must contain at least one number';
    }
    if (!preg_match('/[^A-Za-z0-9]/', $password)) {
        $errors[] = 'Password must contain at least one special character';
    }

    return [
        'valid' => empty($errors),
        'errors' => $errors
    ];
}
```

---

### 8. Enable HTTPS in Development ‚è±Ô∏è 15 min

```bash
# Generate self-signed certificate
cd /path/to/project
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout docker/ssl/localhost.key \
  -out docker/ssl/localhost.crt
```

**Update docker-compose.yml:**

```yaml
services:
  web:
    ports:
      - "8443:443"
    volumes:
      - ./docker/ssl:/etc/nginx/ssl
```

---

### 9. Add Security Headers ‚è±Ô∏è 20 min

**Create includes/security_headers.php:**

```php
<?php
// Set security headers
header('X-Frame-Options: SAMEORIGIN');
header('X-Content-Type-Options: nosniff');
header('X-XSS-Protection: 1; mode=block');
header('Referrer-Policy: strict-origin-when-cross-origin');
header('Permissions-Policy: geolocation=(), microphone=(), camera=()');

// Content Security Policy
header("Content-Security-Policy: " .
    "default-src 'self'; " .
    "script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; " .
    "style-src 'self' 'unsafe-inline' cdn.jsdelivr.net; " .
    "img-src 'self' data: https:; " .
    "font-src 'self' data:; " .
    "connect-src 'self'; " .
    "frame-ancestors 'self'"
);
```

**Include in config/config.php:**

```php
require_once __DIR__ . '/../includes/security_headers.php';
```

---

### 10. Implement Email Verification ‚è±Ô∏è 1 hour

```sql
ALTER TABLE sponsorships ADD COLUMN email_verified BOOLEAN DEFAULT FALSE;
ALTER TABLE sponsorships ADD COLUMN verification_token VARCHAR(255) DEFAULT NULL;
```

**Send verification email on first sponsorship:**

```php
$verificationToken = bin2hex(random_bytes(32));
$verificationUrl = baseUrl('?page=verify_email&token=' . urlencode($verificationToken));

// Store token
Database::update('sponsorships',
    ['verification_token' => password_hash($verificationToken, PASSWORD_DEFAULT)],
    ['id' => $sponsorshipId]
);

// Send email with verification link
```

---

## Testing Checklist

After implementing each fix, verify:

- [ ] Configuration loads without errors
- [ ] Admin login works with new password
- [ ] Portal access tokens work correctly
- [ ] Rate limiting blocks after 5 attempts
- [ ] Remember-me persists across sessions
- [ ] Access log records admin actions
- [ ] Password complexity enforced
- [ ] Security headers present in responses
- [ ] Email verification flow completes

---

## Deployment Checklist

Before deploying to production:

1. [ ] Create `.env` file on server (not in git)
2. [ ] Run database migrations
3. [ ] Test admin login
4. [ ] Test sponsor portal access
5. [ ] Verify HTTPS is enforced
6. [ ] Check error logs for issues
7. [ ] Force default admin password change
8. [ ] Document new environment variables
9. [ ] Update backup procedures
10. [ ] Test rollback plan

---

**Document Version:** 1.0
**Created:** October 13, 2025
**Next Review:** After implementation or 30 days
