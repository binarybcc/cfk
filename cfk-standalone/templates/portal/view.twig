{% extends "layouts/base.twig" %}

{% block title %}{{ pageTitle }}{% endblock %}

{% block head_extra %}
    <style>
        .portal-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .portal-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .portal-header h1 {
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
        }

        .sponsor-email {
            color: var(--color-text-secondary);
            font-size: var(--font-size-md);
        }

        .alert {
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xl);
        }

        .alert-error {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            color: #991b1b;
        }

        .alert-success {
            background: #f0fdf4;
            border: 2px solid #86efac;
            color: #166534;
        }

        .portal-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .sponsorships-summary {
            background: linear-gradient(135deg, #2c5530 0%, #1e3d24 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .sponsorships-summary h2 {
            margin: 0 0 var(--spacing-md) 0;
            color: white;
        }

        .sponsorships-summary p {
            margin: 0;
            font-size: var(--font-size-lg);
        }

        .family-section {
            background: white;
            border: 2px solid var(--color-border-lighter);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .family-header {
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .family-header h3 {
            margin: 0;
            color: var(--color-primary);
            font-size: var(--font-size-xl);
        }

        .children-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        .child-card {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            border: 1px solid var(--color-border-lighter);
        }

        .child-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-primary);
        }

        .child-header h4 {
            margin: 0;
            color: var(--color-primary);
            font-size: var(--font-size-lg);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: 600;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-logged {
            background: #dbeafe;
            color: #1e40af;
        }

        .child-photo {
            text-align: center;
            margin-bottom: var(--spacing-md);
        }

        .child-photo img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-primary);
        }

        .child-details p,
        .clothing-sizes span,
        .child-section p {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: var(--font-size-sm);
        }

        .child-details strong {
            color: var(--color-primary);
        }

        .clothing-sizes {
            background: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            margin: var(--spacing-md) 0;
        }

        .clothing-sizes h5 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--color-primary);
        }

        .sizes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .child-section {
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            background: white;
            border-radius: var(--radius-sm);
        }

        .child-section h5 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--color-primary);
        }

        .child-section.wishes {
            background: #fffbeb;
            border: 1px solid #fef3c7;
        }

        .child-section.special-needs {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .child-meta {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--color-border-lighter);
            color: var(--color-text-secondary);
            font-size: var(--font-size-xs);
        }

        .contact-notice {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            margin-top: var(--spacing-xl);
        }

        .contact-notice h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: #0c4a6e;
        }

        .contact-notice p {
            margin: 0 0 var(--spacing-sm) 0;
        }

        .contact-notice p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .children-grid {
                grid-template-columns: 1fr;
            }

            .portal-actions {
                flex-direction: column;
            }

            .portal-actions .btn {
                width: 100%;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="portal-page">
    {% if valid %}
        {# Display flash messages #}
        {% if session.flash_message is defined %}
            <div class="alert alert-{{ session.flash_type|default('success') }}">
                {{ session.flash_message }}
            </div>
        {% endif %}

        {# Portal Header #}
        <div class="portal-header">
            <h1>üéÑ Your Sponsorship Portal</h1>
            <p class="sponsor-email">Logged in as: <strong>{{ sponsorEmail }}</strong></p>
        </div>

        {# Portal Actions #}
        <div class="portal-actions">
            <a href="{{ baseUrl('/portal/add?token=' ~ token|url_encode) }}" class="btn btn--primary btn--large">
                ‚ûï Add More Children
            </a>
            <a href="{{ baseUrl('/sponsor/lookup') }}" class="btn btn--secondary btn--large">
                ‚Üê Back to Lookup
            </a>
        </div>

        {# Sponsorships Summary #}
        <div class="sponsorships-summary">
            <h2>Your Sponsored Children</h2>
            <p>You are sponsoring <strong>{{ sponsorships|length }}</strong> child(ren) across <strong>{{ families|length }}</strong> family(ies).</p>
        </div>

        {# Display Sponsorships Grouped by Family #}
        {% for family in families %}
            <div class="family-section">
                <div class="family-header">
                    <h3>Family {{ family.family_number }}</h3>
                </div>

                <div class="children-grid">
                    {% for child in family.children %}
                        <div class="child-card">
                            <div class="child-header">
                                <h4>Child {{ child.child_display_id }}</h4>
                                <span class="status-badge status-{{ child.status }}">
                                    {{ child.status|capitalize }}
                                </span>
                            </div>

                            <div class="child-photo">
                                <img src="{{ getPhotoUrl(child.photo_filename, child) }}"
                                     alt="Avatar for {{ child.child_display_id }}">
                            </div>

                            <div class="child-details">
                                <p><strong>Name:</strong> {{ child.child_name }}</p>
                                <p><strong>Age:</strong> {{ displayAge(child.child_age) }}</p>
                                <p><strong>Grade:</strong> {{ child.child_grade }}</p>
                                <p><strong>Gender:</strong> {{ child.child_gender == 'M' ? 'Boy' : 'Girl' }}</p>
                            </div>

                            <div class="clothing-sizes">
                                <h5>Clothing Sizes:</h5>
                                <div class="sizes-grid">
                                    <span>üëï Shirt: {{ child.shirt_size|default('N/A') }}</span>
                                    <span>üëñ Pants: {{ child.pant_size|default('N/A') }}</span>
                                    <span>üëü Shoes: {{ child.shoe_size|default('N/A') }}</span>
                                    <span>üß• Jacket: {{ child.jacket_size|default('N/A') }}</span>
                                </div>
                            </div>

                            {% if child.interests %}
                                <div class="child-section">
                                    <h5>Essential Needs:</h5>
                                    <p>{{ child.interests }}</p>
                                </div>
                            {% endif %}

                            {% if child.wishes %}
                                <div class="child-section wishes">
                                    <h5>üéÅ Christmas Wishes:</h5>
                                    <p>{{ child.wishes }}</p>
                                </div>
                            {% endif %}

                            {% if child.special_needs %}
                                <div class="child-section special-needs">
                                    <h5>‚ö†Ô∏è Special Notes:</h5>
                                    <p>{{ child.special_needs }}</p>
                                </div>
                            {% endif %}

                            <div class="child-meta">
                                <small>Requested: {{ child.request_date|date('M j, Y') }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}

        {# Contact Notice #}
        <div class="contact-notice">
            <h3>Need to Make Changes?</h3>
            <p><strong>We're here to help!</strong> To cancel or modify a sponsorship, please contact Christmas for Kids:</p>
            <p>üìß Email: <a href="mailto:{{ adminEmail }}">{{ adminEmail }}</a></p>
            <p>üìû Phone: {{ contactPhone }}</p>
        </div>

    {% else %}
        {# Access Denied #}
        <div class="alert alert-error">
            <h2>‚ö†Ô∏è Access Denied</h2>
            <p><strong>{{ message }}</strong></p>
            <p>Please request a new access link from the <a href="{{ baseUrl('/sponsor/lookup') }}">sponsor lookup page</a>.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
