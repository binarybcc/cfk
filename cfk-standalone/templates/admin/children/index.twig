{% extends "layouts/admin.twig" %}

{% block title %}{{ pageTitle }}{% endblock %}

{% block head_extra %}
<style>
.filters {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 500;
    color: #333;
    font-size: 0.9rem;
}

.filter-group input,
.filter-group select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

.children-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.child-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.child-header {
    background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.child-id {
    font-size: 1.2rem;
    font-weight: bold;
}

.child-body {
    padding: 1rem;
}

.child-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 0.2rem;
}

.info-value {
    font-weight: 500;
}

.child-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-block;
}

.btn-primary { background: #2c5530; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-success { background: #28a745; color: white; }

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow: hidden;
    position: relative;
}

.modal-header {
    background: #2c5530;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 2rem;
    max-height: 60vh;
    overflow-y: auto;
}

.close {
    font-size: 1.5rem;
    cursor: pointer;
    color: white;
    background: none;
    border: none;
}

.close:hover {
    opacity: 0.7;
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group-full {
    grid-column: span 2;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.form-group textarea {
    min-height: 80px;
    resize: vertical;
}

.form-help {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
    display: block;
}

@media (max-width: 768px) {
    .filters {
        grid-template-columns: 1fr;
    }
    .children-grid {
        grid-template-columns: 1fr;
    }
    .form-grid {
        grid-template-columns: 1fr;
    }
    .form-group-full {
        grid-column: span 1;
    }
    .child-info {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div x-data="childManager()">
    <div class="page-header">
        <h1>{{ pageTitle }}</h1>
        <div class="page-actions">
            <button @click="openAddModal()" class="btn btn-primary">+ Add Child</button>
        </div>
    </div>

    {# Filters #}
    <form method="GET" action="{{ baseUrl('/admin/children') }}" class="filters">
        <div class="filter-group">
            <label for="status">Status:</label>
            <select name="status" id="status">
                <option value="all" {% if filters.status == 'all' %}selected{% endif %}>All Statuses</option>
                <option value="available" {% if filters.status == 'available' %}selected{% endif %}>Available</option>
                <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="sponsored" {% if filters.status == 'sponsored' %}selected{% endif %}>Sponsored</option>
                <option value="inactive" {% if filters.status == 'inactive' %}selected{% endif %}>Inactive</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="family">Family:</label>
            <select name="family" id="family">
                <option value="all">All Families</option>
                {% for family in familyNumbers %}
                    <option value="{{ family.family_number }}" {% if filters.family == family.family_number %}selected{% endif %}>
                        Family {{ family.family_number }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="age">Age Group:</label>
            <select name="age" id="age">
                <option value="all" {% if filters.age == 'all' %}selected{% endif %}>All Ages</option>
                <option value="birth-4" {% if filters.age == 'birth-4' %}selected{% endif %}>Birth-4 (0-4 yrs)</option>
                <option value="elementary" {% if filters.age == 'elementary' %}selected{% endif %}>Elementary (5-10 yrs)</option>
                <option value="middle" {% if filters.age == 'middle' %}selected{% endif %}>Middle School (11-13 yrs)</option>
                <option value="high" {% if filters.age == 'high' %}selected{% endif %}>High School (14-18 yrs)</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="search">Search:</label>
            <input type="text" name="search" id="search" value="{{ filters.search }}" placeholder="Search by ID, interests, wishes...">
        </div>

        <div class="filter-group" style="align-self: flex-end;">
            <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
    </form>

    {# Pagination Info #}
    <div class="pagination-info">
        <p>Showing {{ children|length }} of {{ pagination.totalCount }} children</p>
    </div>

    {# Children Grid #}
    <div class="children-grid">
        {% for child in children %}
            <div class="child-card">
                <div class="child-header">
                    <span class="child-id">{{ child.display_id }}</span>
                    <span class="badge badge-{{ child.status }}">{{ child.status|upper }}</span>
                </div>
                <div class="child-body">
                    <div class="child-info">
                        <div class="info-item">
                            <span class="info-label">Age:</span>
                            <span class="info-value">{{ formatAge(child.age_months) }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gender:</span>
                            <span class="info-value">{{ child.gender == 'M' ? 'Male' : 'Female' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Grade:</span>
                            <span class="info-value">{{ child.grade }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Shirt:</span>
                            <span class="info-value">{{ child.shirt_size }}</span>
                        </div>
                    </div>

                    {% if child.interests %}
                        <div class="info-item">
                            <span class="info-label">Interests:</span>
                            <span class="info-value">{{ child.interests }}</span>
                        </div>
                    {% endif %}

                    {% if child.wishes %}
                        <div class="info-item">
                            <span class="info-label">Wishes:</span>
                            <span class="info-value">{{ child.wishes }}</span>
                        </div>
                    {% endif %}

                    <div class="child-actions">
                        <button @click="openEditModal({{ child.id }})" class="btn btn-secondary btn-sm">Edit</button>
                        <form method="POST" action="{{ baseUrl('/admin/children/' ~ child.id ~ '/delete') }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this child?');">
                            <input type="hidden" name="csrf_token" value="{{ csrfToken }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        {% else %}
            <p>No children found matching your filters.</p>
        {% endfor %}
    </div>

    {# Pagination #}
    {% if pagination.totalPages > 1 %}
        <div class="pagination">
            {% if pagination.currentPage > 1 %}
                <a href="?page={{ pagination.currentPage - 1 }}&{{ query_params }}" class="btn btn-secondary">« Previous</a>
            {% endif %}

            <span class="pagination-info">Page {{ pagination.currentPage }} of {{ pagination.totalPages }}</span>

            {% if pagination.currentPage < pagination.totalPages %}
                <a href="?page={{ pagination.currentPage + 1 }}&{{ query_params }}" class="btn btn-secondary">Next »</a>
            {% endif %}
        </div>
    {% endif %}

    {# Add/Edit Child Modal #}
    <div class="modal" :class="{ 'show': showModal }" @click.self="closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 x-text="modalTitle"></h3>
                <button class="close" @click="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form :action="formAction" method="POST" @submit="validateAge($event)">
                    <input type="hidden" name="csrf_token" value="{{ csrfToken }}">
                    <input type="hidden" name="child_id" x-model="formData.child_id">

                    <div class="form-grid">
                        {# Age Input - Months OR Years #}
                        <div class="form-group form-group-full">
                            <label>Age * <span style="font-size: 0.9em; color: #666;">(Enter as months OR years, not both)</span></label>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <div style="flex: 1;">
                                    <label for="age_months" style="font-size: 0.9em; color: #666; margin-bottom: 0.25rem;">Months (0-24)</label>
                                    <input type="number" id="age_months" name="age_months" x-model="formData.age_months" min="0" max="24" placeholder="e.g., 18">
                                </div>
                                <div style="padding-top: 1.5rem; color: #999; font-weight: bold;">OR</div>
                                <div style="flex: 1;">
                                    <label for="age_years" style="font-size: 0.9em; color: #666; margin-bottom: 0.25rem;">Years (0-18)</label>
                                    <input type="number" id="age_years" name="age_years" x-model="formData.age_years" min="0" max="18" placeholder="e.g., 5">
                                </div>
                            </div>
                            <div x-show="ageError" x-text="ageError" style="color: #dc3545; font-size: 0.9em; margin-top: 0.25rem;"></div>
                        </div>

                        <div class="form-group">
                            <label for="gender">Gender *</label>
                            <select id="gender" name="gender" x-model="formData.gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="grade">Grade</label>
                            <input type="text" id="grade" name="grade" x-model="formData.grade" placeholder="Pre-K, K, 1st, 2nd, etc.">
                        </div>

                        <div class="form-group">
                            <label for="family_id">Family *</label>
                            <select id="family_id" name="family_id" x-model="formData.family_id" required>
                                <option value="">Select Family</option>
                                <option value="new">➕ Create New Family (Auto-assigned)</option>
                                {% for family in families %}
                                    <option value="{{ family.id }}">Family {{ family.family_number }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-help">
                                Family number and child letter are automatically assigned.<br>
                                New families start at the next available number. Child letters start at 'A'.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="school">School</label>
                            <input type="text" id="school" name="school" x-model="formData.school">
                        </div>

                        <div class="form-group">
                            <label for="shirt_size">Shirt Size</label>
                            <input type="text" id="shirt_size" name="shirt_size" x-model="formData.shirt_size" placeholder="XS, S, M, L, XL, etc.">
                        </div>

                        <div class="form-group">
                            <label for="pant_size">Pant Size</label>
                            <input type="text" id="pant_size" name="pant_size" x-model="formData.pant_size" placeholder="XS, S, M, L, XL, etc.">
                        </div>

                        <div class="form-group">
                            <label for="shoe_size">Shoe Size</label>
                            <input type="text" id="shoe_size" name="shoe_size" x-model="formData.shoe_size" placeholder="1, 2, 3, etc.">
                        </div>

                        <div class="form-group">
                            <label for="jacket_size">Jacket Size</label>
                            <input type="text" id="jacket_size" name="jacket_size" x-model="formData.jacket_size" placeholder="XS, S, M, L, XL, etc.">
                        </div>

                        <div class="form-group form-group-full">
                            <label for="interests">Essential Needs</label>
                            <textarea id="interests" name="interests" x-model="formData.interests" placeholder="Basic necessities, clothing needs, school supplies, etc."></textarea>
                        </div>

                        <div class="form-group form-group-full">
                            <label for="wishes">Christmas Wishes</label>
                            <textarea id="wishes" name="wishes" x-model="formData.wishes" placeholder="What would this child like for Christmas?"></textarea>
                        </div>

                        <div class="form-group form-group-full">
                            <label for="special_needs">Special Needs</label>
                            <textarea id="special_needs" name="special_needs" x-model="formData.special_needs" placeholder="Any special considerations, allergies, or needs"></textarea>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee;">
                        <button type="button" @click="closeModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary" x-text="submitButtonText"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function childManager() {
    return {
        showModal: false,
        modalTitle: 'Add New Child',
        formAction: '{{ baseUrl('/admin/children') }}',
        submitButtonText: 'Add Child',
        ageError: '',
        formData: {
            child_id: '',
            age_months: '',
            age_years: '',
            gender: '',
            grade: '',
            family_id: '',
            school: '',
            shirt_size: '',
            pant_size: '',
            shoe_size: '',
            jacket_size: '',
            interests: '',
            wishes: '',
            special_needs: ''
        },

        openAddModal() {
            this.modalTitle = 'Add New Child';
            this.formAction = '{{ baseUrl('/admin/children') }}';
            this.submitButtonText = 'Add Child';
            this.resetForm();
            this.showModal = true;
        },

        openEditModal(childId) {
            this.modalTitle = 'Edit Child';
            this.formAction = '{{ baseUrl('/admin/children/') }}' + childId;
            this.submitButtonText = 'Update Child';
            this.loadChildData(childId);
            this.showModal = true;
        },

        closeModal() {
            this.showModal = false;
            this.resetForm();
        },

        resetForm() {
            this.formData = {
                child_id: '',
                age_months: '',
                age_years: '',
                gender: '',
                grade: '',
                family_id: '',
                school: '',
                shirt_size: '',
                pant_size: '',
                shoe_size: '',
                jacket_size: '',
                interests: '',
                wishes: '',
                special_needs: ''
            };
            this.ageError = '';
        },

        loadChildData(childId) {
            fetch('{{ baseUrl('/admin/children/') }}' + childId + '/data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const child = data.child;
                        this.formData = {
                            child_id: child.id || '',
                            age_months: child.age_months || '',
                            age_years: '',
                            gender: child.gender || '',
                            grade: child.grade || '',
                            family_id: child.family_id || '',
                            school: child.school || '',
                            shirt_size: child.shirt_size || '',
                            pant_size: child.pant_size || '',
                            shoe_size: child.shoe_size || '',
                            jacket_size: child.jacket_size || '',
                            interests: child.interests || '',
                            wishes: child.wishes || '',
                            special_needs: child.special_needs || ''
                        };
                    } else {
                        alert('Failed to load child data');
                    }
                })
                .catch(error => {
                    console.error('Error loading child data:', error);
                    alert('Error loading child data');
                });
        },

        validateAge(event) {
            this.ageError = '';
            const months = this.formData.age_months;
            const years = this.formData.age_years;

            if (!months && !years) {
                this.ageError = 'Please enter age in months OR years';
                event.preventDefault();
                return false;
            }

            if (months && years) {
                this.ageError = 'Please enter age in months OR years, not both';
                event.preventDefault();
                return false;
            }

            return true;
        }
    }
}
</script>
{% endblock %}
