# v1.8.1-cleanup Branch - Ready for Work

**Created:** October 30, 2025
**Status:** ✅ Planning Complete - Ready for Phase 1
**Base:** v1.7.3-production-hardening

---

## ✅ What's Been Done

### 1. Branch Created from v1.7.3
- Started from current production code
- Includes all security fixes (password removal, CSP nonces)
- Includes all v1.7.3 features (temp landing page, CSV improvements, age display fixes)

### 2. Comprehensive Documentation Created

**Master Plan:** `docs/v1.8.1-cleanup-plan.md`
- 4-phase execution strategy
- Production-First methodology
- Testing protocols for each step
- Success metrics and rollback procedures
- Timeline estimate: 11-16 hours

**Branch Guide:** `CLAUDE.md`
- Critical rules for this branch
- Quality check requirements
- Git workflow
- What NOT to do (lessons from v1.8)

### 3. Existing Documentation Leveraged

Already available in this branch:
- ✅ `docs/audits/dead-code-analysis-report.md` - Identifies 3,624 lines to remove
- ✅ `docs/testing/v1.8-cleanup-testing-checklist.md` - Comprehensive testing procedures
- ✅ `docs/v1.8-architecture-and-coding-standards.md` - Coding standards

---

## 🎯 What This Branch Will Do

### Remove Dead Code (3,624 lines)
- 9 deprecated wrapper files in `includes/`
- All have modern replacements in `src/`
- Safe to delete after dependency verification

### Fix Production Code Quality
- Run PHPStan on **ALL** production code (admin, includes, pages, cron)
- Fix critical errors in production files
- Improve type safety and null handling
- Update deprecated Database methods

### Maintain Production Stability
- Test after EVERY change
- One file deletion at a time
- Functional tests must pass (35/36 baseline)
- Full rollback procedure documented

---

## 📋 Next Steps (Phase 1)

### Step 1.1: Create PHPStan Baseline

```bash
# Scan ALL production code (not done in v1.8!)
vendor/bin/phpstan analyse \
  admin/ \
  includes/ \
  pages/ \
  cron/ \
  src/ \
  --level 6 \
  > phpstan-v1.8.1-baseline.txt
```

### Step 1.2: Review Dead Code Report

```bash
# Verify report is current for v1.7.3
cat docs/audits/dead-code-analysis-report.md
```

### Step 1.3: Create Dependency Map

```bash
# Map all production file dependencies
grep -r "require_once\|require\|include_once\|include" \
  admin/ includes/ pages/ cron/ \
  > dependency-map.txt
```

### Step 1.4: Document Baseline

Create: `docs/v1.8.1-baseline-report.md`
- PHPStan error counts by directory
- Deprecated file usage mapping
- Critical vs non-critical issues
- Fix priority list

---

## 🚨 Critical Rules

### Production First Principle (ALWAYS)

```
Priority 1: ALL production code (admin, includes, pages, cron)
Priority 2: Modern code (src/)
Priority 3: Dead code cleanup
Priority 4: Architecture improvements
```

### Quality Checks Before Every Commit

```bash
vendor/bin/phpstan analyse admin/ includes/ pages/ cron/ src/ --level 6
./tests/security-functional-tests.sh
```

### One Change at a Time
- Delete ONE file per commit
- Fix ONE error per commit
- Test after EVERY change
- Document as you go

---

## 📊 Success Metrics

| Metric | Goal |
|--------|------|
| **Deprecated Code Removed** | 3,624 lines (9 files) |
| **PHPStan Errors** | Reduce by 50%+ |
| **Functional Tests** | 35/36 pass (no regression) |
| **Production Code Coverage** | 100% (all directories) |
| **Documentation** | Complete & current |

---

## 🔄 Comparison: v1.8 vs v1.8.1

| Aspect | v1.8-cleanup | v1.8.1-cleanup |
|--------|-------------|----------------|
| **Base** | v1.7.2 | v1.7.3 ✅ |
| **Security** | Staging passwords | Magic-link only ✅ |
| **PHPStan Scope** | src/ only | ALL production ✅ |
| **Quality Checks** | Excluded admin | Include admin ✅ |
| **Testing** | Manual only | Automated + manual ✅ |
| **Documentation** | Created after | Created during ✅ |

---

## 📚 Key Documentation

**Primary References:**
1. **Master Plan**: `docs/v1.8.1-cleanup-plan.md` ⭐ START HERE
2. **Branch Guide**: `CLAUDE.md`
3. **Dead Code Analysis**: `docs/audits/dead-code-analysis-report.md`
4. **Testing Checklist**: `docs/testing/v1.8-cleanup-testing-checklist.md`

**Supporting Docs:**
- Production Status: `PROJECT-STATUS.md`
- Environment Config: `.env` file
- Functional Tests: `tests/security-functional-tests.sh`

---

## ✅ Ready to Start?

**Checklist:**
- [x] Branch created from v1.7.3
- [x] Master plan documented
- [x] Testing methodology defined
- [x] Existing docs reviewed
- [x] Branch guide created
- [ ] **Docker environment running** ← Next: Start Docker
- [ ] **PHPStan baseline created** ← Next: Run Phase 1.1
- [ ] **Functional tests passing** ← Next: Verify baseline

---

## 🚀 Quick Start Commands

```bash
# 1. Start Docker
docker-compose up -d

# 2. Verify environment
docker-compose ps

# 3. Access site
open http://localhost:8082

# 4. Run baseline functional tests
./tests/security-functional-tests.sh

# 5. Create PHPStan baseline (Phase 1.1)
vendor/bin/phpstan analyse admin/ includes/ pages/ cron/ src/ --level 6 > phpstan-v1.8.1-baseline.txt
```

---

## 🎓 Lessons Applied from v1.8

**What went wrong in v1.8:**
- Admin excluded from PHPStan → 9 critical bugs hidden
- Multiple changes without testing → Harder to debug
- Documentation created afterward → Incomplete context
- Staging passwords conflicted with v1.7.3 security model

**What we're doing differently:**
- ✅ PHPStan scans admin from Day 1
- ✅ One change + test + commit cycle
- ✅ Document as we code
- ✅ Use v1.7.3 security model (magic-link only)

---

**Status:** Ready to begin Phase 1 - Quality Baseline & Dependency Analysis

**Estimated Time to Complete:** 11-16 hours (across 4 phases)

**Next Action:** Start Docker and run Phase 1.1 - PHPStan baseline
