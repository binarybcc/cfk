# Apache configuration for CFK Standalone - Production
# Root .htaccess file for cforkids.org

RewriteEngine On

# ============================================
# HTTPS ENFORCEMENT (CRITICAL SECURITY)
# ============================================
# Force HTTPS on all requests
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# SECURITY HEADERS
# ============================================
# These complement PHP headers in includes/header.php
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Clickjacking protection (legacy, CSP frame-ancestors is better)
    Header always set X-Frame-Options "DENY"

    # XSS Protection (legacy but still recommended)
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # HSTS - Force HTTPS for 1 year (critical for security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Permissions Policy - Disable unnecessary browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
</IfModule>

# ============================================
# PERFORMANCE: GZIP COMPRESSION
# ============================================
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json

    # Don't compress images (already compressed)
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|ico|svg)$ no-gzip dont-vary
</IfModule>

# ============================================
# PERFORMANCE: BROWSER CACHING
# ============================================
<IfModule mod_expires.c>
    ExpiresActive On

    # Images - cache for 1 year
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"

    # CSS and JavaScript - cache for 1 month
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"

    # Fonts - cache for 1 year
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"

    # HTML - cache for 1 hour (dynamic content)
    ExpiresByType text/html "access plus 1 hour"

    # Default - cache for 1 week
    ExpiresDefault "access plus 1 week"
</IfModule>

# ============================================
# SECURITY: FILE ACCESS RESTRICTIONS
# ============================================
# Deny access to sensitive files
<FilesMatch "\.(env|ini|log|conf|sql|bak|md|json|lock|yml|yaml)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to hidden files (except .well-known for SSL)
<FilesMatch "^\.(?!well-known)">
    Order allow,deny
    Deny from all
</FilesMatch>

# Deny access to sensitive directories
RedirectMatch 403 ^/(vendor|config|src|tests|database|storage|cron)/.*$

# ============================================
# ROUTING: Send all non-file requests to index.php
# ============================================
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]

# ============================================
# PHP SECURITY SETTINGS
# ============================================
<IfModule mod_php.c>
    # Disable dangerous PHP functions
    php_flag display_errors Off
    php_flag log_errors On

    # Limit file uploads
    php_value upload_max_filesize 10M
    php_value post_max_size 10M

    # Session security
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_only_cookies 1
</IfModule>

# ============================================
# CUSTOM ERROR PAGES (Optional)
# ============================================
# ErrorDocument 404 /404.php
# ErrorDocument 500 /500.php
